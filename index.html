<!DOCTYPE html>
<html>

<head>

  <title>Character Sheet</title>
  <style>
    h2 {
      text-align: center;
    }

    .row {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .col {
      flex: 1 1 45%;
      margin: 10px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .stats-table th,
    .stats-table td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }

    .btn-row button {
      margin-right: 10px;
    }

    #hp-speed {
      margin-top: 20px;
      font-size: 1.1em;
    }

    .affinities {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 5px;
    }

    .affinities div {
      background-color: #3d3d5c;
      color: #e0e0ff;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .affinities div:hover {
      background-color: #50507a;
    }

    .stat-display {
      font-size: 1.2em;
    }

    .stat-breakdown {
      font-size: 0.85em;
      color: #555;
    }

    body {
      background-color: #1e1e2f;
      color: #e0e0e0;
    }

    .container {
      background-color: #2a2a40;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px #00000080;
    }

    input[type="text"],
    input[type="number"],
    select,
    button,
    textarea {
      background-color: #3a3a55;
      color: #ffffff;
      border: 1px solid #555;
      border-radius: 4px;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #8888ff;
      box-shadow: 0 0 5px #8888ff50;
    }

    button {
      background-color: #444466;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #555588;
    }

    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
      color: #ccc;
    }

    h2 {
      color: #ffffff;
      text-align: center;
    }

    .stat-label {
      font-weight: bold;
      margin-right: 5px;
    }

    .stat-breakdown {
      font-size: 0.85em;
      color: #aaaaaa;
      margin-left: 5px;
    }

    .equipment-section h3 {
      color: #ccc;
      text-align: center;
      margin-bottom: 10px;
    }

    .equipment-section {
      background-color: #1f1f2f;
      /* keep your dark color */
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      width: 100%;
    }

    .equipment-grid {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .equipment-row {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .equipment-slots-row {
      display: flex;
      gap: 14px;
    }

    .derived-stat {
      position: absolute;
      left: 40px;
      top: 50%;
      transform: translateY(-180%);
      color: #fff;
      font-weight: bold;
      font-size: 20px;
      pointer-events: none;
    }

    .fraction {
      display: inline-block;
      text-align: center;
      font-size: 0.8em;
      vertical-align: middle;
      line-height: 1.2;
    }

    .fraction .top {
      display: block;
      padding: 0 2px;
      margin-bottom: 4px;
      /* Raise the number higher */
      position: relative;
    }

    .fraction .top::after {
      content: "";
      position: absolute;
      bottom: -2px;
      /* Space between number and line */
      left: 0;
      right: 0;
      height: 1px;
      background: white;
    }

    .fraction .bottom {
      display: block;
      padding: 0 2px;
    }

    #attack-formula,
    #defense-formula {
      margin-right: 15px;
    }

    #derived-attack,
    #derived-defense {
      color: yellow;
      font-size: 26px;

    }

    .slot {
      width: 130px;
      height: 130px;
      background-color: #2a2a2a;
      border: 2px dashed #555;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: background-color 0.2s, border-color 0.2s;
    }

    .slot:hover {
      background-color: #3a3a3a;
    }

    .slot img.item-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none; /* Let clicks pass through to the slot icon */
    }

    .slot .change-item-icon {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background-color: rgba(0,0,0,0.6);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        border: 1px solid #888;
        transition: background-color 0.2s;
    }
    .slot .change-item-icon:hover {
        background-color: #555588;
    }


    .selected-weapon {
      border-color: gold;
      box-shadow: 0 0 8px gold;
    }

    /* Modals (Shared Styles) */
    .modal-backdrop {
      position: fixed;
      top: 5%;
      left: 5%;
      width: 90%;
      height: 90%;
      background-color: #1e1e2f;
      border: 2px solid #555;
      border-radius: 8px;
      z-index: 999;
      display: none;
      flex-direction: column;
      padding: 20px;
      overflow: auto;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
    }

    /* Item Card Styles (for Library) */
     .item-card {
      background-color: #2a2a2a;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
      text-align: center;
    }

    .item-card:hover {
      background-color: #333;
    }

    .item-card img {
      width: 100%;
      height: 100px;
      object-fit: contain;
      margin-bottom: 8px;
    }
     .item-card .item-name {
      font-weight: bold;
      margin-bottom: 4px;
    }
     .item-card.undiscovered {
        filter: grayscale(1) brightness(0.6);
        cursor: not-allowed;
     }

    /* Tooltip */
    #tooltip {
        position: absolute;
        display: none;
        background-color: #1e1e2f;
        border: 1px solid #8888ff;
        border-radius: 6px;
        padding: 10px;
        z-index: 1000;
        max-width: 300px;
        pointer-events: none; /* so it doesn't interfere with mouse events */
        box-shadow: 0 0 10px #00000080;
    }
    #tooltip .tooltip-name {
        font-size: 1.1em;
        font-weight: bold;
        color: gold;
        margin-bottom: 5px;
    }
    #tooltip .tooltip-stats {
        margin-bottom: 5px;
        color: #ccc;
    }
    #tooltip .tooltip-effect {
        font-style: italic;
        color: #aaa;
    }

    /* Skill Sections */
    .skill-section {
      margin-top: 20px;
      padding: 10px;
      background-color: #1f1f1f;
      border-radius: 8px;
    }

    /* Tier Sections */
    .tier-section {
      margin-bottom: 15px;
      border-top: 1px solid #444;
      padding-top: 10px;
    }

    /* Tier Header */
    .tier-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    /* Skill Slot Grid */
    .skill-slots {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Individual Skill Slot */
    .skill-slot {
      width: 48px;
      height: 48px;
      border: 2px dashed #555;
      background-color: #2c2c2c;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }

    .skill-slot:hover {
      background-color: #3a3a3a;
    }

    .skill-slot img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Empty Skill Slot Indicator */
    .skill-slot.empty::after {
      content: '+';
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .skill-card {
      background-color: #2a2a2a;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .skill-card:hover {
      background-color: #333;
    }

    .skill-card img {
      width: 100%;
      height: 100px;
      object-fit: contain;
      margin-bottom: 8px;
    }

    .skill-card .skill-name {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .skill-card .skill-description {
      font-size: 12px;
      color: #aaa;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Character Sheet</h2>

    <div style="margin-bottom: 10px;">
      <button onclick="signInWithGoogle()">Sign In with Google</button>
      <button onclick="signOut()" id="logoutBtn" style="display:none;">Sign Out</button>
      <button onclick="saveCharacter()">Save Character</button>
      <button onclick="resetCharacter()">Reset Character</button>
      <span id="user-info" style="margin-left: 10px;"></span>
    </div>

    <div class="row">
      <div class="col">
        <label>Name</label>
        <input type="text" id="char-name">

        <label>Race</label>
        <input type="text" id="char-race">

        <label>Position</label>
        <select id="char-position" onchange="updateFromTextbox()">
          <option value="Guide">Guide</option>
          <option value="Fisherman">Fisherman</option>
          <option value="Spear Bearer">Spear Bearer</option>
          <option value="Wave Controller">Wave Controller</option>
          <option value="Light Bearer">Light Bearer</option>
          <option value="Anima">Anima</option>
        </select>

        <label>Primary Stats</label>
        <div class="affinities" id="primary-affinities"></div>
        <select id="add-primary"></select>

        <label>Secondary Stats</label>
        <div class="affinities" id="secondary-affinities"></div>
        <select id="add-secondary"></select>

        <label>Tertiary Stats</label>
        <div class="affinities" id="tertiary-affinities"></div>
        <select id="add-tertiary"></select>

        <label>Level</label>
        <input type="number" id="char-level" min="1" value="1" onchange="updateFromTextbox()">

        <label>Floor</label>
        <input type="number" id="char-floor" min="1" value="1" onchange="renderHpSpeed()">

        <label>Stat Point Multiplier</label>
        <input type="number" id="stat-multiplier" min="1" step="0.1" value="1.5">
      </div>

      <div class="col">
        <label>Available Stat Points</label>
        <input type="number" id="available-stat-points" value="0" readonly>

        <label>Available Skill Points</label>
        <input type="number" id="available-skill-points" value="0" readonly>

        <div class="btn-row">
          <button onclick="levelUp()">Level Up</button>
          <button onclick="addSkillPoint()">+1 Skill Point</button>
        </div>
      </div>
    </div>

    <div id="hp-speed"></div>

    <div class="equipment-section">
      <h3>Equipment</h3>
      <div class="equipment-grid">
        <div class="equipment-row">
          <div class="derived-stat attack">
            <span class="fraction">
              <span class="top" id="attack-formula-top"></span>
              <span class="bottom" id="attack-formula-bot"></span>
            </span>
            <span class="fraction" id="attack-formula"></span><span id="derived-attack">0</span></span>
          </div>
          <div class="equipment-slots-row">
            <div class="slot" id="weapon1-slot" title="Weapon Slot 1"></div>
            <div class="slot" id="armor-slot" title="Armor"></div>
            <div class="slot" id="weapon2-slot" title="Weapon Slot 2"></div>
          </div>
        </div>
        <div class="equipment-row">
          <div class="derived-stat defense">
            <span class="fraction">
              <span class="top" id="defense-formula-top"></span>
              <span class="bottom" id="defense-formula-bot"></span>
            </span>
            <span class="fraction" id="defense-formula"></span><span id="derived-defense">0</span></span>
          </div>
          <div class="equipment-slots-row">
            <div class="slot" id="accessory1-slot" title="Accessory 1"></div>
            <div class="slot" id="accessory2-slot" title="Accessory 2"></div>
          </div>
        </div>
      </div>
    </div>

    <h3>Stats</h3>
    <table class="stats-table" id="stats-table">
      <thead>
        <tr>
          <th>Stat</th>
          <th>Value</th>
          <th>+1</th>
        </tr>
      </thead>
      <tbody id="stats-body"></tbody>
    </table>

    <div class="skill-section" id="skill-section">
      </div>

    <div id="skill-library-modal" class="modal-backdrop">
      <div class="modal-header">
        <h3>Skill Library</h3>
        <button onclick="closeSkillLibrary()">Close</button>
      </div>
      <div class="modal-grid" id="skill-library-grid">
        </div>
    </div>

    <div id="equipment-library-modal" class="modal-backdrop">
        <div class="modal-header">
          <h3 id="equipment-modal-title">Equipment Library</h3>
          <button onclick="closeEquipmentModal()">Close</button>
        </div>
        <div class="modal-grid" id="equipment-library-grid">
          </div>
    </div>

    <div id="tooltip"></div>

  </div>

  </script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>

  <script>
    // 2. Your Firebase Project Configuration (from Project Settings > General)
    const firebaseConfig = {
      apiKey: "AIzaSyCr08RHyYpKBy3omDUtSmYYr3KkXxx30E4",
      authDomain: "tog-charactersheet.firebaseapp.com",
      projectId: "tog-charactersheet",
      storageBucket: "tog-charactersheet.firebasestorage.app",
      messagingSenderId: "915406998560",
      appId: "1:915406998560:web:4edbb2e3deb9d70c0a4045",
      measurementId: "G-ZMQF30F2FC"
    };


    // 3. Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();


    // 4. Auth UI Logic
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          document.getElementById("user-info").textContent = `Logged in as ${user.displayName}`;
          document.getElementById("logoutBtn").style.display = 'inline-block';
          loadCharacter(); // Auto-load on login
        })
        .catch(error => console.error("Login error", error));
    }


    function signOut() {
      auth.signOut().then(() => {
        document.getElementById("user-info").textContent = "Logged out.";
        document.getElementById("logoutBtn").style.display = 'none';
      });
    }


    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("user-info").textContent = `Logged in as ${user.displayName}`;
        document.getElementById("logoutBtn").style.display = 'inline-block';
        document.querySelectorAll("input, select, button").forEach(el => el.disabled = false);
        loadCharacter();
        fetchEquipmentLibrary(); // Fetch global items on login
      } else {
        document.getElementById("user-info").textContent = "Logged out.";
        document.getElementById("logoutBtn").style.display = 'none';
        document.querySelectorAll("input, select, button").forEach(el => {
          if (!el.closest("body > .container > div > button")) el.disabled = true;
        });
      }
    });



    // 5. Save & Load Character
    function getCurrentCharacterData() {
      return {
        level: document.getElementById("char-level").value,
        floor: document.getElementById("char-floor").value,
        name: document.getElementById("char-name").value,
        race: document.getElementById("char-race").value,
        position: document.getElementById("char-position").value,
        affinities: state.affinities,
        stats: state.statValues,
        skillsByTier: state.skillsByTier,
        manualAdds: state.manualStatPoints,
        equipment: state.equipment,
        derivedStats: state.derivedStats,
        selectedWeaponSlot: state.selectedWeaponSlot
      };
    }


    function saveCharacter() {
      const user = auth.currentUser;
      if (user) {
        db.collection("characters").doc(user.uid).set(getCurrentCharacterData())
          .then(() => alert("Character saved!"))
          .catch(err => console.error("Save failed:", err));
      }
    }


    function loadCharacter() {
      const user = auth.currentUser;
      if (user) {
        db.collection("characters").doc(user.uid).get()
          .then(doc => {
            if (doc.exists) {
              const data = doc.data();
              document.getElementById("char-name").value = data.name;
              document.getElementById("char-race").value = data.race;
              document.getElementById("char-level").value = data.level;
              document.getElementById("char-floor").value = data.floor;
              document.getElementById("char-position").value = data.position;
              state.affinities = data.affinities || { primary: [], secondary: [], tertiary: [] };
              state.statValues = data.stats || {};
              state.skillsByTier = data.skillsByTier || { 1: [], 2: [], 3: [], 4: [], 5: [] };
              state.manualStatPoints = data.manualAdds || Object.fromEntries(stats.map(stat => [stat, 0]));
              state.derivedStats = data.derivedStats || { attack: 0, defense: 0 };
              state.equipment = data.equipment || { weapon1: null, weapon2: null, armor: null, accessory1: null, accessory2: null };
              state.selectedWeaponSlot = data.selectedWeaponSlot || null;

              updateFromTextbox(); // This now calls all necessary render functions
            }
          })
          .catch(err => console.error("Load failed:", err));
      }
    }
  </script>

  <script>
    const stats = ["Strength", "Shinsu Control", "Shinsu Endurance", "Perception", "Willpower", "Technique", "Insight", "Authority"];
    const state = {
      statValues: Object.fromEntries(stats.map(stat => [stat, 1])),
      manualStatPoints: Object.fromEntries(stats.map(stat => [stat, 0])),
      statHistory: [],
      skillsByTier: { 1: [], 2: [], 3: [], 4: [], 5: [] },
      currentSkillEdit: { tier: null, index: null },
      skillLibrary: [],
      equipmentLibrary: [],
      currentEquipmentEdit: null, // e.g., 'weapon1-slot'
      skillFilter: { position: "", tier: null, search: "" },
      availableStatPoints: 0,
      availableSkillPoints: 0,
      bonusSkillPoints: 0,
      usedSkillPoints: 0,
      affinities: { primary: [], secondary: [], tertiary: [] },
      derivedStats: { attack: 0, defense: 0 },
      equipment: {
        weapon1: null,
        weapon2: null,
        armor: null,
        accessory1: null,
        accessory2: null
      },
      selectedWeaponSlot: null
    };

    function renderAffinityControls() {
      ["primary", "secondary", "tertiary"].forEach(type => {
        const container = document.getElementById(`${type}-affinities`);
        const select = document.getElementById(`add-${type}`);
        container.innerHTML = "";
        select.innerHTML = "<option value=''>+ Add</option>" + stats.map(stat => `<option value="${stat}">${stat}</option>`).join("");

        state.affinities[type].forEach(stat => {
          const div = document.createElement("div");
          div.textContent = stat;
          div.onclick = () => {
            state.affinities[type] = state.affinities[type].filter(s => s !== stat);
            updateFromTextbox();
          };
          container.appendChild(div);
        });

        select.onchange = e => {
          const val = e.target.value;
          if (val && !state.affinities[type].includes(val)) {
            state.affinities[type].push(val);
            updateFromTextbox();
          }
        };
      });
    }
    
    // --- NEW: Tooltip Functions ---
    const tooltip = document.getElementById('tooltip');
    function showTooltip(event, item) {
        if (!item) return;
        const html = `
            <div class="tooltip-name">${item.name}</div>
            <div class="tooltip-stats">
                Type: ${item.type}<br>
                Stat: ${item.stat} | Modifier: ${item.modifier}
            </div>
            <div class="tooltip-effect">${item.specialEffect || 'No special effect.'}</div>
        `;
        tooltip.innerHTML = html;
        tooltip.style.display = 'block';
        tooltip.style.left = `${event.pageX + 15}px`;
        tooltip.style.top = `${event.pageY + 15}px`;
    }

    function hideTooltip() {
        tooltip.style.display = 'none';
    }
    
    function renderEquipment() {
      const allSlots = ["weapon1", "weapon2", "armor", "accessory1", "accessory2"];

      allSlots.forEach(slotKey => {
        const el = document.getElementById(`${slotKey}-slot`);
        const item = state.equipment[slotKey];

        el.innerHTML = ""; // Clear old content
        el.onmouseover = (e) => showTooltip(e, item);
        el.onmouseout = hideTooltip;

        if (item) {
          const img = document.createElement("img");
          img.src = item.image || "default.png";
          img.alt = item.name || slotKey;
          img.className = "item-image";
          el.appendChild(img);
        }
        
        // Add the 'change item' icon regardless of whether an item is equipped
        const changeIcon = document.createElement("div");
        changeIcon.className = "change-item-icon";
        changeIcon.textContent = item ? '⇄' : '+';
        changeIcon.onclick = () => openEquipmentModal(slotKey);
        el.appendChild(changeIcon);

        // Weapon selection border logic
        if (slotKey === "weapon1" || slotKey === "weapon2") {
            el.classList.toggle("selected-weapon", state.selectedWeaponSlot === slotKey);
            // Click on the slot itself (not the change icon) to select it for attack
            el.onclick = () => {
                if (state.equipment[slotKey]) { // Can only select if a weapon is equipped
                    state.selectedWeaponSlot = (state.selectedWeaponSlot === slotKey) ? null : slotKey;
                    updateDerivedStats();
                    renderEquipment(); // Re-render to show selection border
                }
            };
        }
      });
    }

    function getGrowthTable() {
      return {
        Guide: [
          { range: [1, 10], primary: 1, secondary: 0.5, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 2, secondary: 1.5, tertiary: 1 },
          { range: [81, 110], primary: 2.5, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 3, secondary: 2, tertiary: 1.5 },
          { range: [141, 170], primary: 3, secondary: 2.5, tertiary: 2 },
          { range: [171, Infinity], primary: 4, secondary: 3, tertiary: 3 }
        ],
        Fisherman: [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 2, secondary: 2, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 3, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 4, secondary: 3, tertiary: 3 }
        ],
        "Spear Bearer": [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
        ],
        "Wave Controller": [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
        ],
        "Light Bearer": [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
        ],
        Anima: [
          { range: [1, 10], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 2.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 3, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3.5, secondary: 1.5, tertiary: 1 },
          { range: [81, 110], primary: 4, secondary: 1.5, tertiary: 1 },
          { range: [111, 140], primary: 5, secondary: 2, tertiary: 1.5 },
          { range: [141, 170], primary: 6, secondary: 2, tertiary: 1.5 },
          { range: [171, Infinity], primary: 6, secondary: 2, tertiary: 2 }
        ]
      };
    }

    function getGrowthRatesForLevel(position, level) {
      const table = getGrowthTable()[position] || [];
      return table.find(r => level >= r.range[0] && level <= r.range[1]) || { primary: 0, secondary: 0, tertiary: 0 };
    }

    function updateFromTextbox() {
      const level = parseInt(document.getElementById("char-level").value);
      const pos = document.getElementById("char-position").value;
      const priList = state.affinities.primary;
      const secList = state.affinities.secondary;
      const terList = state.affinities.tertiary;

      stats.forEach(stat => {
        const base = 1;
        let total = base;

        for (let i = 1; i <= level; i++) {
          const rates = getGrowthRatesForLevel(pos, i);
          if (priList.includes(stat)) total += rates.primary;
          if (secList.includes(stat)) total += rates.secondary;
          if (terList.includes(stat)) total += rates.tertiary;
        }

        state.statValues[stat] = total + state.manualStatPoints[stat];
      });
      const totalAllocatedStatPoints = Object.values(state.manualStatPoints).reduce((sum, val) => sum + val, 0);

      state.availableStatPoints = level - totalAllocatedStatPoints - 1;
      state.availableSkillPoints = level - state.usedSkillPoints - 1 + state.bonusSkillPoints;
      document.getElementById("available-stat-points").value = state.availableStatPoints;
      document.getElementById("available-skill-points").value = state.availableSkillPoints;
      
      // Centralized rendering calls
      renderStats();
      renderHpSpeed();
      renderAffinityControls();
      renderEquipment();
      renderSkillTiers();
      updateDerivedStats();
    }
    
    function renderStats() {
      const tbody = document.getElementById("stats-body");
      tbody.innerHTML = "";

      const average = stats.reduce((sum, stat) => sum + state.statValues[stat], 0) / stats.length;
      const max = parseFloat(document.getElementById("stat-multiplier").value) * average;

      stats.forEach(stat => {
        const tr = document.createElement("tr");
        const value = state.statValues[stat] || 0;
        const manual = state.manualStatPoints[stat] || 0;
        
        tr.innerHTML = `
            <td>${stat}</td>
            <td>
                ${value.toFixed(1)}
                <div class="stat-breakdown">(Base ${(value - manual).toFixed(1)} + Manual ${manual})</div>
            </td>
            <td>
                <button class="add-stat-btn">+</button>
                <button class="remove-stat-btn">–</button>
            </td>
        `;
        
        tr.querySelector('.add-stat-btn').onclick = () => {
            if (state.availableStatPoints > 0 && state.statValues[stat] + 1 <= Math.floor(max)) {
                state.statValues[stat]++;
                state.manualStatPoints[stat]++;
                state.availableStatPoints--;
                document.getElementById("available-stat-points").value = state.availableStatPoints;
                updateDerivedStats();
                renderStats();
                renderHpSpeed();
            }
        };

        tr.querySelector('.remove-stat-btn').onclick = () => {
            if (state.manualStatPoints[stat] > 0) {
                state.statValues[stat]--;
                state.manualStatPoints[stat]--;
                state.availableStatPoints++;
                document.getElementById("available-stat-points").value = state.availableStatPoints;
                updateDerivedStats();
                renderStats();
                renderHpSpeed();
            }
        };

        tbody.appendChild(tr);
      });
    }


    function renderHpSpeed() {
      const floor = parseInt(document.getElementById("char-floor").value);
      const level = parseInt(document.getElementById("char-level").value);
      const se = state.statValues["Shinsu Endurance"];
      const str = state.statValues["Strength"];
      const wp = state.statValues["Willpower"];

      const movePenalty = Math.max(0, 2 * floor - se);
      const speed = 6 + level - movePenalty;

      let hpMultiplier = 2 + Math.floor(level / 25);
      const hp = 3 * se + 2 * str + 1.5 * wp + level * hpMultiplier;

      document.getElementById("hp-speed").innerHTML = `<b>HP:</b> ${Math.round(hp)}<br><b>Movement Speed:</b> ${speed}`;
    }

    function addSkillPoint() {
      state.availableSkillPoints++;
      state.bonusSkillPoints++;
      document.getElementById("available-skill-points").value = state.availableSkillPoints;
    }

    function levelUp() {
      document.getElementById("char-level").value++;
      updateFromTextbox();
    }

    function resetCharacter() {
      if (!confirm("Are you sure you want to completely reset and delete this character? This cannot be undone.")) return;
      
      const user = auth.currentUser;
      if (!user) return;
      
      db.collection("characters").doc(user.uid).delete().then(() => {
        // Reset all input fields
        document.getElementById("char-name").value = "";
        document.getElementById("char-race").value = "";
        document.getElementById("char-level").value = 1;
        document.getElementById("char-floor").value = 1;
        document.getElementById("char-position").value = "Guide";
        
        // Reset state object to its initial values
        Object.assign(state, {
            statValues: Object.fromEntries(stats.map(stat => [stat, 1])),
            manualStatPoints: Object.fromEntries(stats.map(stat => [stat, 0])),
            skillsByTier: { 1: [], 2: [], 3: [], 4: [], 5: [] },
            affinities: { primary: [], secondary: [], tertiary: [] },
            equipment: { weapon1: null, weapon2: null, armor: null, accessory1: null, accessory2: null },
            selectedWeaponSlot: null,
            bonusSkillPoints: 0,
            usedSkillPoints: 0
        });

        // Trigger a full UI refresh
        updateFromTextbox();
        alert("Character has been reset.");
      }).catch(err => console.error("Failed to delete character:", err));
    }

    function updateDerivedStats() {
      const stats = state.statValues;
      const eq = state.equipment;

      // Attack Calculation
      const selected = state.selectedWeaponSlot;
      let attack = 0;
      if (selected && eq[selected]) {
        const weapon = eq[selected];
        const abase = state.statValues[weapon.stat] || 0;
        attack = Math.floor(abase / 5) + (weapon.modifier || 0);
        document.getElementById("attack-formula-top").textContent = `(${abase.toFixed(1)} ${weapon.stat})`;
        document.getElementById("attack-formula-bot").textContent = `5`;
        document.getElementById("attack-formula").innerHTML = ` &nbsp;+&nbsp; ${weapon.modifier} Mod &nbsp;=&nbsp;`;
      } else {
        document.getElementById("attack-formula-top").textContent = "";
        document.getElementById("attack-formula-bot").textContent = "";
        document.getElementById("attack-formula").innerHTML = "";
      }

      // Defense Calculation
      let defense = 0;
      if (eq.armor) {
        const armor = eq.armor;
        const dbase = state.statValues[armor.stat] || 0;
        defense = Math.floor(dbase / 5) + (armor.modifier || 0);
        document.getElementById("defense-formula-top").textContent = `(${dbase.toFixed(1)} ${armor.stat})`;
        document.getElementById("defense-formula-bot").textContent = `5`;
        document.getElementById("defense-formula").innerHTML = ` &nbsp;+&nbsp; ${armor.modifier} Mod &nbsp;=&nbsp;`;
      } else {
        document.getElementById("defense-formula-top").textContent = "";
        document.getElementById("defense-formula-bot").textContent = "";
        document.getElementById("defense-formula").innerHTML = "";
      }

      state.derivedStats = { attack, defense };
      document.getElementById("derived-attack").textContent = `${attack} Attack`;
      document.getElementById("derived-defense").textContent = `${defense} Defense`;
    }

    function equipItem(slot, item) {
      state.equipment[slot] = item;
      // If equipping a weapon and no weapon is selected for attack, select this one.
      if (item.type === 'weapon' && !state.selectedWeaponSlot) {
        state.selectedWeaponSlot = slot;
      }
      // If replacing the currently selected weapon, it remains selected.
      // If unequipping the currently selected weapon, clear the selection.
      if (!item && state.selectedWeaponSlot === slot) {
        state.selectedWeaponSlot = null;
      }

      updateDerivedStats();
      renderEquipment();
    }
    
    // --- NEW: Equipment Library Functions ---
    async function fetchEquipmentLibrary() {
        try {
            const snapshot = await db.collection("items").get();
            state.equipmentLibrary = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error("Error fetching equipment library:", error);
            // Fallback to local data if Firebase fails
            state.equipmentLibrary = [
              { id: 'mystery', name: '???', image: 'https://dummyimage.com/100x100/333/aaa&text=?', isDiscovered: false },
              { id: 'ironsword', name: 'Iron Sword', image: 'https://dummyimage.com/100x100/aaa/000&text=S', type: 'weapon', stat: 'Strength', modifier: 5, specialEffect: 'A standard, reliable blade.', isDiscovered: true },
              { id: 'leatherarmor', name: 'Leather Armor', image: 'https://dummyimage.com/100x100/8b4513/fff&text=A', type: 'armor', stat: 'Willpower', modifier: 3, specialEffect: 'Simple but effective protection.', isDiscovered: true }
            ];
        }
    }
    
    function openEquipmentModal(slotKey) {
        state.currentEquipmentEdit = slotKey;
        const modal = document.getElementById("equipment-library-modal");
        const title = slotKey.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        document.getElementById("equipment-modal-title").textContent = `Equip to ${title}`;
        modal.classList.add("active");
        renderEquipmentLibrary();
    }

    function closeEquipmentModal() {
        document.getElementById("equipment-library-modal").classList.remove("active");
        state.currentEquipmentEdit = null;
    }
    
    function renderEquipmentLibrary() {
        const grid = document.getElementById("equipment-library-grid");
        grid.innerHTML = "";
        const slotKey = state.currentEquipmentEdit;
        const slotType = slotKey.includes('weapon') ? 'weapon' : (slotKey.includes('armor') ? 'armor' : 'accessory');

        const filteredItems = state.equipmentLibrary.filter(item => item.type === slotType);

        filteredItems.forEach(item => {
            const card = document.createElement("div");
            card.className = "item-card";
            card.onmouseover = (e) => showTooltip(e, item.isDiscovered ? item : null);
            card.onmouseout = hideTooltip;

            if (item.isDiscovered) {
                card.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" />
                    <div class="item-name">${item.name}</div>
                `;
                card.onclick = () => selectEquipment(item);
            } else {
                card.classList.add("undiscovered");
                card.innerHTML = `
                    <img src="https://dummyimage.com/100x100/333/aaa&text=?" alt="Undiscovered" />
                    <div class="item-name">Undiscovered Item</div>
                `;
            }
            grid.appendChild(card);
        });
    }

    function selectEquipment(item) {
        const slotKey = state.currentEquipmentEdit;
        if (slotKey) {
            equipItem(slotKey, item);
            closeEquipmentModal();
        }
    }

    // --- SKILL SECTION ---

    function addSkillSlot(tier) {
      if (!state.skillsByTier[tier]) {
        state.skillsByTier[tier] = [];
      }
      state.skillsByTier[tier].push(null); // Use null for empty slots
      renderSkillTiers();
    }
    
    function renderSkillTiers() {
      const container = document.getElementById("skill-section");
      container.innerHTML = "";

      for (let tier = 1; tier <= 5; tier++) {
        const tierDiv = document.createElement("div");
        tierDiv.className = "tier-section";

        tierDiv.innerHTML = `
            <div class="tier-header">
                <h4>Tier ${tier}</h4>
                <button onclick="addSkillSlot(${tier})">Add Skill Slot</button>
            </div>
            <div class="skill-slots" id="tier-${tier}-slots"></div>
        `;
        
        const slotGrid = tierDiv.querySelector(`#tier-${tier}-slots`);
        const skills = state.skillsByTier[tier] || [];
        skills.forEach((skill, index) => {
          const slot = document.createElement("div");
          slot.className = "skill-slot";
          if (!skill || !skill.image) {
            slot.classList.add("empty");
          } else {
            const img = document.createElement("img");
            img.src = skill.image;
            img.alt = skill.name;
            slot.appendChild(img);
          }

          slot.onclick = () => openSkillLibrary(tier, index);
          slotGrid.appendChild(slot);
        });

        container.appendChild(tierDiv);
      }
    }

    function openSkillLibrary(tier, index) {
      state.currentSkillEdit = { tier, index };
      document.getElementById("skill-library-modal").classList.add("active");
      renderSkillLibrary();
    }

    function closeSkillLibrary() {
      document.getElementById("skill-library-modal").classList.remove("active");
    }

    function renderSkillLibrary() {
      const grid = document.getElementById("skill-library-grid");
      grid.innerHTML = "";

      const filtered = state.skillLibrary.filter(skill => {
        const position = document.getElementById("char-position").value;
        return skill.positionTags.includes(position);
      });

      filtered.forEach(skill => {
        const card = document.createElement("div");
        card.className = "skill-card";
        card.onclick = () => selectSkill(skill);

        card.innerHTML = `
          <img src="${skill.icon}" alt="${skill.name}" />
          <div class="skill-name">${skill.name}</div>
          <div class="skill-description">${skill.description}</div>
        `;
        grid.appendChild(card);
      });
    }

    function selectSkill(skill) {
      const { tier, index } = state.currentSkillEdit;
      if (tier && index !== null && state.skillsByTier[tier]) {
        state.skillsByTier[tier][index] = {
          name: skill.name,
          image: skill.icon
          // Add other skill properties here if needed
        };
        renderSkillTiers();
        closeSkillLibrary();
      }
    }
    
    // --- INITIALIZATION ---
    
    // Placeholder data, will be replaced by Firebase fetch
    state.skillLibrary = [
      {
        name: "Fireball",
        icon: "https://dummyimage.com/100x100/ff4444/ffffff&text=F",
        description: "Launches a fiery orb that explodes on impact.",
        positionTags: ["Wave Controller", "Anima"]
      },
    ];

    window.onload = () => {
      // The auth listener will trigger loadCharacter and fetchEquipmentLibrary,
      // which in turn call updateFromTextbox to render everything.
      // This ensures nothing renders until we know if the user is logged in.
    };
  </script>
</body>
</html>