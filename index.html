<!DOCTYPE html>
<html>

<head>

  <title>Character Sheet</title>
  <style>
    h2 {
      text-align: center;
    }

    .row {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .col {
      flex: 1 1 45%;
      margin: 10px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .stats-table th,
    .stats-table td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }

    .btn-row button {
      margin-right: 10px;
    }

    #hp-speed {
      margin-top: 20px;
      font-size: 1.1em;
    }

    .affinities {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 5px;
    }

    .affinities div {
      background-color: #3d3d5c;
      color: #e0e0ff;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .affinities div:hover {
      background-color: #50507a;
    }

    .stat-display {
      font-size: 1.2em;
    }

    .stat-breakdown {
      font-size: 0.85em;
      color: #555;
    }

    body {
      background-color: #1e1e2f;
      color: #e0e0e0;
    }

    .container {
      background-color: #2a2a40;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px #00000080;
    }

    input[type="text"],
    input[type="number"],
    select,
    button,
    textarea {
      background-color: #3a3a55;
      color: #ffffff;
      border: 1px solid #555;
      border-radius: 4px;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #8888ff;
      box-shadow: 0 0 5px #8888ff50;
    }

    button {
      background-color: #444466;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #555588;
    }

    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
      color: #ccc;
    }

    h2 {
      color: #ffffff;
      text-align: center;
    }

    .stat-label {
      font-weight: bold;
      margin-right: 5px;
    }

    .stat-breakdown {
      font-size: 0.85em;
      color: #aaaaaa;
      margin-left: 5px;
    }

    .equipment-section {
      background-color: #1f1f2a;
      border-radius: 8px;
      padding: 16px;
      margin-top: 14px;
    }

    .equipment-section h3 {
      color: #ccc;
      text-align: center;
      margin-bottom: 10px;
    }

    .equipment-grid {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .slot {
      width: 110px;
      height: 110px;
      background-color: #333444;
      border: 2px dashed #666;
      border-radius: 6px;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .slot:hover {
      border-color: #888;
    }

    /* Skill Sections */
    .skills-section {
      margin-top: 20px;
      padding: 10px;
      background-color: #1f1f1f;
      border-radius: 8px;
    }

    /* Tier Sections */
    .tier-section {
      margin-bottom: 15px;
      border-top: 1px solid #444;
      padding-top: 10px;
    }

    /* Tier Header */
    .tier-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    /* Skill Slot Grid */
    .skill-slots {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Individual Skill Slot */
    .skill-slot {
      width: 48px;
      height: 48px;
      border: 2px dashed #555;
      background-color: #2c2c2c;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }

    .skill-slot:hover {
      background-color: #3a3a3a;
    }

    .skill-slot img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Empty Skill Slot Indicator */
    .skill-slot.empty::after {
      content: '+';
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .skill-option {
      background: #333;
      border: 1px solid #555;
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .skill-option img {
      width: 32px;
      height: 32px;
    }

    .close {
      float: right;
      font-size: 20px;
      color: #999;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Character Sheet</h2>

    <div style="margin-bottom: 10px;">
      <button onclick="signInWithGoogle()">Sign In with Google</button>
      <button onclick="signOut()" id="logoutBtn" style="display:none;">Sign Out</button>
      <button onclick="saveCharacter()">Save Character</button>
      <button onclick="resetCharacter()">Reset Character</button>
      <span id="user-info" style="margin-left: 10px;"></span>
    </div>

    <div class="row">
      <div class="col">
        <label>Name</label>
        <input type="text" id="char-name">

        <label>Race</label>
        <input type="text" id="char-race">

        <label>Position</label>
        <select id="char-position" onchange="updateFromTextbox()">
          <option value="Guide">Guide</option>
          <option value="Fisherman">Fisherman</option>
          <option value="Spear Bearer">Spear Bearer</option>
          <option value="Wave Controller">Wave Controller</option>
          <option value="Light Bearer">Light Bearer</option>
          <option value="Anima">Anima</option>
        </select>

        <label>Primary Stats</label>
        <div class="affinities" id="primary-affinities"></div>
        <select id="add-primary"></select>

        <label>Secondary Stats</label>
        <div class="affinities" id="secondary-affinities"></div>
        <select id="add-secondary"></select>

        <label>Tertiary Stats</label>
        <div class="affinities" id="tertiary-affinities"></div>
        <select id="add-tertiary"></select>

        <label>Level</label>
        <input type="number" id="char-level" min="1" value="1" onchange="updateFromTextbox()">

        <label>Floor</label>
        <input type="number" id="char-floor" min="1" value="1" onchange="renderHpSpeed()">

        <label>Stat Point Multiplier</label>
        <input type="number" id="stat-multiplier" min="1" step="0.1" value="1.5">
      </div>

      <div class="col">
        <label>Available Stat Points</label>
        <input type="number" id="available-stat-points" value="0" readonly>

        <label>Available Skill Points</label>
        <input type="number" id="available-skill-points" value="0" readonly>

        <div class="btn-row">
          <button onclick="levelUp()">Level Up</button>
          <button onclick="addSkillPoint()">+1 Skill Point</button>
        </div>
      </div>
    </div>

    <div id="hp-speed"></div>

    <!-- Add this inside your .container, after base stats -->
    <div class="equipment-section">
      <h3>Equipment</h3>
      <div class="equipment-grid">
        <div class="slot" id="weapon1-slot" title="Weapon Slot 1"></div>
        <div class="slot" id="armor-slot" title="Armor"></div>
        <div class="slot" id="weapon2-slot" title="Weapon Slot 2"></div>
        <div class="slot" id="accessory1-slot" title="Accessory 1"></div>
        <div class="slot" id="accessory2-slot" title="Accessory 2"></div>
      </div>
    </div>


    <h3>Stats</h3>
    <table class="stats-table" id="stats-table">
      <thead>
        <tr>
          <th>Stat</th>
          <th>Value</th>
          <th>+1</th>
        </tr>
      </thead>
      <tbody id="stats-body"></tbody>
    </table>

    <div class="tier-section">
      <div class="tier-header">
        <strong>Tier 1</strong>
        <button onclick="addSkillSlot(1)">Add Skill Slot</button>
      </div>
      <div class="skill-slots" id="tier-1-slots">
        <!-- Dynamically added slots -->
      </div>
    </div>


    <div class="skills-section" id="skills-section">
      <!-- This will be filled by renderSkills() -->
    </div>

    <!-- Skill Modal -->
    <div id="skill-modal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close" onclick="closeSkillModal()">&times;</span>
        <h4>Select a Skill</h4>
        <div id="skill-options" class="skill-options">
          <!-- Placeholder, to be populated later -->
          <div class="skill-option" onclick="selectSkill('Flame Slash', 'flame.png')">
            <img src="flame.png" alt="Flame Slash">
            <span>Flame Slash</span>
          </div>
        </div>
      </div>
    </div>



  </div>

  </script>
  <!-- 1. Firebase SDK Scripts (put just before </body>) -->

  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>

  <script>
    // 2. Your Firebase Project Configuration (from Project Settings > General)
    const firebaseConfig = {
      apiKey: "AIzaSyCr08RHyYpKBy3omDUtSmYYr3KkXxx30E4",
      authDomain: "tog-charactersheet.firebaseapp.com",
      projectId: "tog-charactersheet",
      storageBucket: "tog-charactersheet.firebasestorage.app",
      messagingSenderId: "915406998560",
      appId: "1:915406998560:web:4edbb2e3deb9d70c0a4045",
      measurementId: "G-ZMQF30F2FC"
    };


    // 3. Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();


    // 4. Auth UI Logic
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          document.getElementById("user-info").textContent = `Logged in as ${user.displayName}`;
          document.getElementById("logoutBtn").style.display = 'inline-block';
          loadCharacter(); // Auto-load on login
        })
        .catch(error => console.error("Login error", error));
    }


    function signOut() {
      auth.signOut().then(() => {
        document.getElementById("user-info").textContent = "Logged out.";
        document.getElementById("logoutBtn").style.display = 'none';
      });
    }


    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("user-info").textContent = `Logged in as ${user.displayName}`;
        document.getElementById("logoutBtn").style.display = 'inline-block';
        document.querySelectorAll("input, select, button").forEach(el => el.disabled = false);
        loadCharacter();
      } else {
        document.getElementById("user-info").textContent = "Logged out.";
        document.getElementById("logoutBtn").style.display = 'none';
        document.querySelectorAll("input, select, button").forEach(el => {
          if (!el.closest("body > .container > div > button")) el.disabled = true;
        });
      }
    });



    // 5. Save & Load Character
    function getCurrentCharacterData() {
      return {
        level: document.getElementById("char-level").value,
        floor: document.getElementById("char-floor").value,
        name: document.getElementById("char-name").value,
        race: document.getElementById("char-race").value,
        position: document.getElementById("char-position").value,
        affinities: state.affinities,
        stats: state.statValues,
        // skills: state.skillSlots,
        skillsByTier: state.skillsByTier,
        manualAdds: state.manualStatPoints,
        equipment: state.equipment
      };
    }


    function saveCharacter() {
      const user = auth.currentUser;
      if (user) {
        db.collection("characters").doc(user.uid).set(getCurrentCharacterData())
          .then(() => alert("Character saved!"))
          .catch(err => console.error("Save failed:", err));
      }
    }


    function loadCharacter() {
      const user = auth.currentUser;
      if (user) {
        db.collection("characters").doc(user.uid).get()
          .then(doc => {
            if (doc.exists) {
              const data = doc.data();
              document.getElementById("char-name").value = data.name;
              document.getElementById("char-race").value = data.race;
              document.getElementById("char-level").value = data.level;
              document.getElementById("char-floor").value = data.floor;
              document.getElementById("char-position").value = data.position;
              state.affinities = data.affinities || { primary: [], secondary: [], tertiary: [] };
              state.statValues = data.stats || {};
              state.skillsByTier = data.skillsByTier || { 1: [], 2: [], 3: [], 4: [], 5: [] };
              state.manualStatPoints = data.manualAdds || Object.fromEntries(stats.map(stat => [stat, 0]));
              state.equipment = data.equipment || {
                weapon1: null,
                weapon2: null,
                armor: null,
                accessory1: null,
                accessory2: null
              };

              updateFromTextbox();
              renderSkills();
            }
          })
          .catch(err => console.error("Load failed:", err));
      }
    }
  </script>

  <script>
    const stats = ["Strength", "Shinsu Control", "Shinsu Endurance", "Perception", "Willpower", "Technique", "Insight", "Authority"];
    const state = {
      statValues: Object.fromEntries(stats.map(stat => [stat, 1])),
      manualStatPoints: Object.fromEntries(stats.map(stat => [stat, 0])),
      statHistory: [],
      skillsByTier: { 1: [], 2: [], 3: [], 4: [], 5: [] },
      currentSkillEdit: { tier: null, index: null },
      availableStatPoints: 0,
      availableSkillPoints: 0,
      affinities: { primary: [], secondary: [], tertiary: [] },
      equipment: {
        weapon1: null,
        weapon2: null,
        armor: null,
        accessory1: null,
        accessory2: null
      }
    };

    function renderAffinityControls() {
      ["primary", "secondary", "tertiary"].forEach(type => {
        const container = document.getElementById(`${type}-affinities`);
        const select = document.getElementById(`add-${type}`);
        container.innerHTML = "";
        select.innerHTML = "<option value=''>+ Add</option>" + stats.map(stat => `<option value="${stat}">${stat}</option>`).join("");

        state.affinities[type].forEach(stat => {
          const div = document.createElement("div");
          div.textContent = stat;
          div.onclick = () => {
            state.affinities[type] = state.affinities[type].filter(s => s !== stat);
            updateFromTextbox();
          };
          container.appendChild(div);
        });

        select.onchange = e => {
          const val = e.target.value;
          if (val && !state.affinities[type].includes(val)) {
            state.affinities[type].push(val);
            updateFromTextbox();
          }
        };
      });
    }

    function renderEquipment() {
      for (const slot in state.equipment) {
        const element = document.getElementById(`${slot}-slot`);
        const item = state.equipment[slot];
        if (item && item.image) {
          element.style.backgroundImage = `url(${item.image})`;
          element.title = item.name;
        } else {
          element.style.backgroundImage = '';
          element.title = slot.replace(/([a-z])([A-Z])/g, '$1 $2');
        }
      }
    }

    function getGrowthTable() {
      return {
        Guide: [
          { range: [1, 10], primary: 1, secondary: 0.5, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 2, secondary: 1.5, tertiary: 1 },
          { range: [81, 110], primary: 2.5, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 3, secondary: 2, tertiary: 1.5 },
          { range: [141, 170], primary: 3, secondary: 2.5, tertiary: 2 },
          { range: [171, Infinity], primary: 4, secondary: 3, tertiary: 3 }
        ],
        Fisherman: [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 2, secondary: 2, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 3, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 4, secondary: 3, tertiary: 3 }
        ],
        "Spear Bearer": [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
        ],
        "Wave Controller": [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
        ],
        "Light Bearer": [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
        ],
        Anima: [
          { range: [1, 10], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 2.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 3, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3.5, secondary: 1.5, tertiary: 1 },
          { range: [81, 110], primary: 4, secondary: 1.5, tertiary: 1 },
          { range: [111, 140], primary: 5, secondary: 2, tertiary: 1.5 },
          { range: [141, 170], primary: 6, secondary: 2, tertiary: 1.5 },
          { range: [171, Infinity], primary: 6, secondary: 2, tertiary: 2 }
        ]
      };
    }

    function getGrowthRatesForLevel(position, level) {
      const table = getGrowthTable()[position] || [];
      return table.find(r => level >= r.range[0] && level <= r.range[1]) || { primary: 0, secondary: 0, tertiary: 0 };
    }

    function updateFromTextbox() {
      const level = parseInt(document.getElementById("char-level").value);
      const pos = document.getElementById("char-position").value;
      const priList = state.affinities.primary;
      const secList = state.affinities.secondary;
      const terList = state.affinities.tertiary;

      stats.forEach(stat => {
        const base = 1;
        let total = base;

        for (let i = 1; i <= level; i++) {
          const rates = getGrowthRatesForLevel(pos, i);
          if (priList.includes(stat)) total += rates.primary;
          if (secList.includes(stat)) total += rates.secondary;
          if (terList.includes(stat)) total += rates.tertiary;
        }

        state.statValues[stat] = total + state.manualStatPoints[stat];
      });

      state.availableStatPoints = level - 1;
      state.availableSkillPoints = level - 1;
      document.getElementById("available-stat-points").value = state.availableStatPoints;
      document.getElementById("available-skill-points").value = state.availableSkillPoints;
      renderStats();
      renderHpSpeed();
      renderAffinityControls();
      renderEquipment();
    }

    function renderStats() {
      const tbody = document.getElementById("stats-body");
      tbody.innerHTML = "";

      const average = stats.reduce((sum, stat) => sum + state.statValues[stat], 0) / stats.length;
      const max = parseFloat(document.getElementById("stat-multiplier").value) * average;

      stats.forEach(stat => {
        const tr = document.createElement("tr");

        const td1 = document.createElement("td");
        td1.textContent = stat;

        const td2 = document.createElement("td");
        td2.innerHTML = `
          ${state.statValues[stat].toFixed(1)}
          <div class="stat-breakdown">(Base ${(state.statValues[stat] - state.manualStatPoints[stat]).toFixed(1)} + Manual ${state.manualStatPoints[stat]})</div>
        `;

        const td3 = document.createElement("td");
        const addBtn = document.createElement("button");
        const removeBtn = document.createElement("button");
        addBtn.textContent = "+";
        removeBtn.textContent = "–";

        addBtn.onclick = () => {
          if (state.availableStatPoints > 0 && state.statValues[stat] + 1 <= Math.floor(max)) {
            state.statValues[stat]++;
            state.manualStatPoints[stat]++;
            state.availableStatPoints--;
            document.getElementById("available-stat-points").value = state.availableStatPoints;
            renderStats();
            renderHpSpeed();
          }
        };

        removeBtn.onclick = () => {
          if (state.manualStatPoints[stat] > 0) {
            state.statValues[stat]--;
            state.manualStatPoints[stat]--;
            state.availableStatPoints++;
            document.getElementById("available-stat-points").value = state.availableStatPoints;
            renderStats();
            renderHpSpeed();
          }
        };

        td3.appendChild(addBtn);
        td3.appendChild(removeBtn);

        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tbody.appendChild(tr);
      });
    }


    function renderHpSpeed() {
      const floor = parseInt(document.getElementById("char-floor").value);
      const level = parseInt(document.getElementById("char-level").value);
      const se = state.statValues["Shinsu Endurance"];
      const str = state.statValues["Strength"];
      const wp = state.statValues["Willpower"];

      const movePenalty = Math.max(0, 2 * floor - se);
      const speed = 6 + level - movePenalty;

      let hpMultiplier = 2 + Math.floor(level / 25);
      const hp = 3 * se + 2 * str + 1.5 * wp + level * hpMultiplier;

      document.getElementById("hp-speed").innerHTML = `<b>HP:</b> ${Math.round(hp)}<br><b>Movement Speed:</b> ${speed}`;
    }

    function addSkillPoint() {
      state.availableSkillPoints++;
      document.getElementById("available-skill-points").value = state.availableSkillPoints;
    }

    function levelUp() {
      document.getElementById("char-level").value++;
      updateFromTextbox();
    }

    function addSkillSlot(tier) {
      state.skillSlots.push({ tier: tier, name: "" });
      state.skillSlots.sort((a, b) => a.tier - b.tier);
      renderSkills();
    }


    function resetCharacter() {
      if (!auth.currentUser) return;
      db.collection("characters").doc(auth.currentUser.uid).delete().then(() => {
        document.getElementById("char-name").value = "";
        document.getElementById("char-race").value = "";
        document.getElementById("char-level").value = 1;
        document.getElementById("char-floor").value = 1;
        state.affinities = { primary: [], secondary: [], tertiary: [] };
        state.statValues = Object.fromEntries(stats.map(stat => [stat, 1]));
        state.manualStatPoints = Object.fromEntries(stats.map(stat => [stat, 0]));
        state.skillSlots = [];
        updateFromTextbox();
        renderSkills();
      });
    }


    // function renderSkills() {
    //   const tbody = document.getElementById("skills-body");
    //   tbody.innerHTML = "";
    //   state.skillSlots.forEach((slot, index) => {
    //     const tr = document.createElement("tr");
    //     const td1 = document.createElement("td");
    //     td1.textContent = `Tier ${slot.tier}`;
    //     const td2 = document.createElement("td");
    //     const input = document.createElement("input");
    //     input.value = slot.name;
    //     input.onchange = e => state.skillSlots[index].name = e.target.value;
    //     td2.appendChild(input);
    //     tr.appendChild(td1);
    //     tr.appendChild(td2);
    //     tbody.appendChild(tr);
    //   });
    // }

    function renderSkills() {
      const section = document.getElementById("skills-section");
      section.innerHTML = "";

      for (let tier = 1; tier <= 5; tier++) {
        const tierDiv = document.createElement("div");
        tierDiv.className = "tier-section";

        const header = document.createElement("div");
        header.className = "tier-header";
        header.innerHTML = `<strong>Tier ${tier}</strong> <button onclick="addSkillSlot(${tier})">Add Skill Slot</button>`;
        tierDiv.appendChild(header);

        const slotContainer = document.createElement("div");
        slotContainer.className = "skill-slots";
        slotContainer.id = `tier-${tier}-slots`;

        state.skillsByTier[tier].forEach((skill, idx) => {
          const slot = document.createElement("div");
          slot.className = "skill-slot";
          slot.onclick = () => openSkillModal(tier, idx);
          if (skill && skill.image) {
            const img = document.createElement("img");
            img.src = skill.image;
            slot.appendChild(img);
          } else {
            slot.textContent = "+";
          }
          slotContainer.appendChild(slot);
        });

        tierDiv.appendChild(slotContainer);
        section.appendChild(tierDiv);
      }
    }


    function renderSkillTiers() {
      const container = document.getElementById("skill-tiers");
      container.innerHTML = "";
      for (let tier = 1; tier <= 5; tier++) {
        const div = document.createElement("div");
        div.className = "skill-tier";


        const header = document.createElement("h4");
        header.textContent = `Tier ${tier}`;
        div.appendChild(header);


        const slots = document.createElement("div");
        state.skillsByTier[tier].forEach((skill, index) => {
          const slot = document.createElement("div");
          slot.className = "skill-slot";
          if (!skill) {
            slot.classList.add("empty");
          } else {
            slot.style.backgroundImage = `url(${skill.image})`;
          }
          slot.onclick = () => openSkillModal(tier, index);
          slots.appendChild(slot);
        });
        div.appendChild(slots);


        const addBtn = document.createElement("button");
        addBtn.textContent = "Add Skill Slot";
        addBtn.onclick = () => {
          state.skillsByTier[tier].push(null);
          renderSkillTiers();
        };
        div.appendChild(addBtn);


        container.appendChild(div);
      }
    }

    function openSkillModal(tier, index) {
      state.currentSkillEdit = { tier, index };
      document.getElementById("skill-modal").style.display = "flex";
    }


    function closeSkillModal() {
      document.getElementById("skill-modal").style.display = "none";
    }


    function selectSkill(name, image) {
      const { tier, index } = state.currentSkillEdit;
      state.skillsByTier[tier][index] = { name, image };
      closeSkillModal();
      renderSkillTiers();
    }


    document.addEventListener("DOMContentLoaded", () => {
      renderSkillTiers();
    });

    // Initialize
    window.onload = () => {
      renderAffinityControls();
      updateFromTextbox();
      renderSkills();
      renderEquipment();
    };

  </script>


</body>

</html>