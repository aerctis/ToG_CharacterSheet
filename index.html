TODOs:

NEW FEATURES:
-Position specific sections (such as equipped lighthouse and lighout library for lightbearers, tamed creature beastiary
parallel for anima)
-For equipped lighthouse display on the right of equipment images (symmetric to the derived stats)
-Currency. Show currency amount (points). Shop button to open shop model (fancy styling) library with buying and
selling. Can manually add points as well. The the shop should only be open at my discretion, there should be a way for
me to open the shop to all users. And choose what Items go there. Items in the shop should automatically become
discovered.
-hit dice (like DnD). Should be on the page somewhere scale off stats.
-Proficiencies. In the skills modal there should be a toggle for proficiency in that skill, this will change what the
skill does and the info for it. There should also be a way to be proficient in a category of skills (uses the new skill
type tag)
-Inventory for special items. A new modal that can be opened. Allows users to add items manually and write about them
(we will store these items so they are saved, but not create them ourselves). (miscellanous items the characters aquire
that shuold be kept track of).
-Backsory section (A medium sized flexible text section that allows the users to put in backstory and information about
there character.) (hopefully with cool design and display features.)

<!DOCTYPE html>
<html>

<head>
  <title>Character Sheet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* --- CSS Variables for Easy Theming --- */
    :root {
      --font-family: 'Poppins', sans-serif;
      --bg-primary: #1e1e2f;
      --bg-secondary: #2a2a40;
      --bg-inset: #1f1f2f;
      --text-primary: #e0e0e0;
      --text-secondary: #a0a0c0;
      --border-color: #4a4a6a;
      --accent-primary: #555588;
      --accent-hover: #6a6aac;
      --accent-gold: #ffd700;
      --danger-color: #b82a2a;
    }

    /* --- General & Body Styles --- */
    * {
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-family);
      font-size: 16px;
    }

    .container {
      background-color: var(--bg-secondary);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 15px #00000080;
      max-width: 1200px;
      margin: 20px auto;
    }

    h2 {
      text-align: center;
      color: white;
      font-weight: 600;
      margin-bottom: 24px;
    }

    h3 {
      text-align: center;
      color: white;
      margin-top: 40px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    /* --- Modern Header Grid Layout --- */
    .character-header-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-areas: "info points level" "affinities affinities affinities" "auth auth auth";
      gap: 20px;
      margin-bottom: 30px;
    }

    .info-block {
      grid-area: info;
    }

    .points-block {
      grid-area: points;
    }

    .level-block {
      grid-area: level;
    }

    .affinities-block {
      grid-area: affinities;
    }

    .auth-block {
      grid-area: auth;
    }

    .info-block,
    .points-block,
    .level-block,
    .affinities-block {
      background-color: var(--bg-inset);
      padding: 15px;
      border-radius: 8px;
    }

    .auth-block {
      padding: 10px;
      text-align: center;
      border-top: 1px solid var(--border-color);
      margin-top: 10px;
    }

    .info-block h4,
    .points-block h4,
    .level-block h4,
    .affinities-block h4 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--text-secondary);
      font-size: 0.9em;
      text-align: center;
    }

    /* --- Modern Form Elements & Buttons --- */
    label {
      font-weight: 600;
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
      color: var(--text-secondary);
      font-size: 0.9em;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 8px 10px;
      width: 100%;
      font-family: var(--font-family);
      font-size: 1em;
    }

    input[readonly] {
      background-color: #252535;
    }

    button {
      background-color: var(--accent-primary);
      cursor: pointer;
      transition: background-color 0.2s;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 15px;
      font-family: var(--font-family);
      font-weight: 600;
      font-size: 0.9em;
    }

    button:hover {
      background-color: var(--accent-hover);
    }

    button:disabled {
      background-color: #2a2a3a;
      color: #777;
      cursor: not-allowed;
    }

    button.btn-primary {
      background-color: var(--accent-gold);
      color: black;
      width: 100%;
      margin-top: 10px;
    }

    button.btn-primary:hover {
      background-color: #fffac0;
    }

    /* --- Affinity Tags Styling --- */
    .affinities {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 17px;
    }

    .affinities div {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border-radius: 15px;
      padding: 5px 12px;
      position: relative;
      cursor: default;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
    }

    .affinities div:hover {
      background-color: #40405a;
    }

    .remove-affinity {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: var(--bg-inset);
      color: var(--text-secondary);
      font-size: 12px;
      margin-left: 8px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s, background-color 0.2s;
    }

    .affinities div:hover .remove-affinity {
      opacity: 1;
    }

    .remove-affinity:hover {
      background-color: var(--danger-color);
      color: white;
    }

    .affinity-controls {
      display: flex;
      gap: 10px;
    }

    .affinity-controls label {
      margin: 0;
      align-self: center;
    }

    .affinity-controls select {
      flex-grow: 1;
    }

    /* --- Improved Stats Table --- */
    .stats-table .remove-stat-btn {
      margin-left: 8px;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 1.1em;
    }

    .stats-table th,
    .stats-table td {
      border: 1px solid var(--border-color);
      padding: 12px;
      text-align: center;
    }

    .stats-table th {
      background-color: var(--bg-inset);
      font-weight: 600;
    }

    .stats-table tbody tr:nth-child(even) {
      background-color: var(--bg-inset);
    }

    .stat-breakdown {
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .stat-capped {
      color: var(--danger-color);
      font-weight: 600;
      animation: pulse-red 1.5s infinite;
    }

    @keyframes pulse-red {

      0%,
      100% {
        text-shadow: 0 0 3px rgba(255, 50, 50, 0.5);
      }

      50% {
        text-shadow: 0 0 10px rgba(255, 50, 50, 1);
      }
    }

    .stat-flash-error {
      animation: flash-red-bg 0.5s ease-out;
    }

    @keyframes flash-red-bg {
      from {
        background-color: rgba(184, 42, 42, 0.5);
      }

      to {
        background-color: transparent;
      }
    }

    /* --- Equipment Section --- */
    .equipment-section {
      background-color: var(--bg-inset);
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      width: 100%;
    }

    .equipment-grid {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .equipment-row {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .equipment-slots-row {
      display: flex;
      gap: 14px;
    }

    .derived-stat {
      position: absolute;
      left: 15px;
      top: 45%;
      transform: translateY(-50%);
      color: #fff;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .derived-stat-formula {
      display: flex;
      align-items: center;
      font-weight: bold;
      font-size: 0.9em;
    }

    .derived-stat-result {
      color: var(--accent-gold);
      font-weight: 600;
      font-size: 1.5em;
      line-height: 1;
    }

    .fraction {
      display: inline-block;
      text-align: center;
      font-size: .8em;
      vertical-align: middle;
      line-height: 1.2;
    }

    .fraction .top {
      display: block;
      padding: 0 2px;
      margin-bottom: 4px;
      position: relative;
    }

    .fraction .top::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 1px;
      background: #fff;
    }

    .fraction .bottom {
      display: block;
      padding: 0 2px;
    }

    .slot {
      width: 130px;
      height: 130px;
      background-color: #2a2a2a;
      border: 2px dashed #555;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: background-color .2s, border-color .2s;
    }

    .slot:hover {
      background-color: #3a3a3a;
    }

    .slot img.item-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }

    .slot .change-item-icon {
      position: absolute;
      bottom: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      background-color: rgba(0, 0, 0, .6);
      color: #fff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      border: 1px solid #888;
      transition: background-color .2s;
      font-size: 14px;
    }

    .slot .change-item-icon:hover {
      background-color: var(--accent-hover);
    }

    .selected-weapon {
      border-color: var(--accent-gold);
      box-shadow: 0 0 8px var(--accent-gold);
    }

    /* --- Modals --- */
    .modal-backdrop {
      position: fixed;
      top: 5%;
      left: 5%;
      width: 90%;
      height: 90%;
      background-color: var(--bg-primary);
      border: 2px solid #555;
      border-radius: 8px;
      z-index: 999;
      display: none;
      flex-direction: column;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-shrink: 0;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
    }

    /* --- Library Search Bar --- */
    .library-search {
      width: 100%;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 20px;
      font-size: 1em;
    }

    /* --- Library Item/Skill Cards --- */
    .item-card,
    .skill-card {
      background-color: #2a2a2a;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: background-color .2s;
      text-align: center;
      position: relative;
    }

    .item-card:hover,
    .skill-card:hover {
      background-color: #333;
    }

    .item-card img {
      width: 100%;
      height: 100px;
      object-fit: contain;
      margin-bottom: 8px;
    }

    .item-card .item-name {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .item-card.undiscovered {
      filter: grayscale(1) brightness(.6);
      cursor: not-allowed;
    }

    .card-button {
      position: absolute;
      top: 5px;
      left: 5px;
      width: 24px;
      height: 24px;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border: 1px solid #888;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
      z-index: 2;
    }

    .card-button:hover {
      background-color: var(--accent-primary);
    }

    .card-button.owned {
      color: var(--accent-gold);
    }

    .card-button.discover-btn {
      background-color: var(--danger-color);
    }

    /* --- SKILLS Section --- */
    .skill-section {
      margin-top: 20px;
      padding: 10px;
      background-color: var(--bg-inset);
      border-radius: 8px;
    }

    .tier-section {
      margin-bottom: 15px;
      border-top: 1px solid #444;
      padding-top: 10px;
    }

    .tier-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .skill-slots {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .skill-slot {
      width: 96px;
      height: 96px;
      border: 2px dashed #555;
      background-color: #2c2c2c;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color .2s;
      position: relative;
    }

    .skill-slot:hover {
      background-color: #3a3a3a;
    }

    .skill-slot img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
    }

    .skill-slot.empty::after {
      content: '+';
      color: #aaa;
      font-size: 48px;
      position: absolute;
    }

    .skill-slot .skill-level-badge {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.7);
      color: var(--accent-gold);
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
      padding: 2px 5px;
    }

    .info-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      z-index: 2;
      fill: white;
      transition: fill 0.2s;
    }

    .info-icon:hover {
      fill: var(--accent-gold);
    }

    .skill-card {
      padding: 12px;
    }

    .skill-card .skill-name {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .skill-card .skill-description {
      font-size: 12px;
      color: #aaa;
    }

    /* --- Skill Info Modal --- */
    #skill-info-modal-content {
      display: flex;
      gap: 20px;
    }

    #skill-info-modal .left-panel {
      flex: 1;
    }

    #skill-info-modal .right-panel {
      flex: 2;
      overflow-y: auto;
      max-height: 70vh;
    }

    #skill-info-modal img {
      max-width: 150px;
      margin: 0 auto;
      display: block;
      border-radius: 8px;
    }

    #skill-info-modal .level-up-controls {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #555;
    }

    .level-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 1em;
    }

    .level-table th,
    .level-table td {
      border: 1px solid #444;
      padding: 8px;
      text-align: left;
    }

    .level-table th {
      background-color: #3a3a55;
    }

    .level-table .current-level-row {
      background-color: #50507a;
      font-weight: bold;
    }

    /* --- Other --- */
    #hp-speed {
      background-color: var(--bg-inset);
      border-radius: 8px;
      padding: 15px;
      margin-top: 20px;
      font-size: 1.2em;
      font-weight: 600;
      text-align: center;
      line-height: 1.6;
    }

    #hp-speed .accent-label {
      color: var(--accent-gold);
    }

    select:focus {
      border-color: var(--accent-gold);
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
    }

    button:active {
      animation: button-flash 0.2s ease-out;
    }

    @keyframes button-flash {
      0% {
        box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
      }

      100% {
        box-shadow: 0 0 10px 10px rgba(255, 215, 0, 0);
      }
    }

    /* --- Print Styles --- */
    @media print {
      body {
        background-color: white;
        color: black;
        font-size: 10pt;
      }

      .container {
        box-shadow: none;
        border: 1px solid #ccc;
      }

      h2,
      h3 {
        color: black;
      }

      .character-header-grid,
      .auth-block,
      .level-block button,
      .info-block,
      .points-block,
      .level-block,
      .affinities-block,
      .equipment-section,
      .skill-section,
      .modal-backdrop,
      .slot .change-item-icon,
      .info-icon,
      .stats-table button,
      .tier-header button {
        display: none;
      }

      .stats-table {
        font-size: 1em;
      }

      .stats-table td,
      .stats-table th {
        padding: 5px;
      }

      .stat-breakdown {
        display: none;
      }

      .container {
        padding: 0;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Character Sheet</h2>

    <div class="character-header-grid">
      <div class="auth-block">
        <button onclick="signInWithGoogle()">Sign In with Google</button>
        <button onclick="signOut()" id="logoutBtn" style="display:none;">Sign Out</button>
        <button onclick="resetCharacter()">Reset Character</button>
        <span id="user-info" style="margin-left: 10px;"></span>
      </div>
      <div class="info-block">
        <h4>Identity</h4>
        <label>Name</label><input type="text" id="char-name" oninput="handleInputChange()">
        <label>Race</label><input type="text" id="char-race" oninput="handleInputChange()">
        <label>Position</label>
        <select id="char-position" onchange="handleInputChange()">
          <option value="Guide">Guide</option>
          <option value="Fisherman">Fisherman</option>
          <option value="Spear Bearer">Spear Bearer</option>
          <option value="Wave Controller">Wave Controller</option>
          <option value="Light Bearer">Light Bearer</option>
          <option value="Anima">Anima</option>
        </select>
      </div>
      <div class="points-block">
        <h4>Resources</h4>
        <label>Available Stat Points</label><input type="number" id="available-stat-points" value="0" readonly>
        <label>Available Skill Points</label><input type="number" id="available-skill-points" value="0" readonly>
        <label>Stat Point Multiplier</label><input type="number" id="stat-multiplier" min="1" step="0.1" value="1.5"
          oninput="handleInputChange()">
      </div>
      <div class="level-block">
        <h4>Progression</h4>
        <label>Level</label><input type="number" id="char-level" min="1" value="1" oninput="handleInputChange()">
        <label>Floor</label><input type="number" id="char-floor" min="1" value="1" oninput="handleInputChange()">
        <button onclick="levelUp()" class="btn-primary">Level Up</button>
      </div>
      <div class="affinities-block">
        <div class="affinity-controls"><label>Primary Stats</label><select id="add-primary"></select></div>
        <div class="affinities" id="primary-affinities"></div>
        <div class="affinity-controls" style="margin-top: 15px;"><label>Secondary Stats</label><select
            id="add-secondary"></select></div>
        <div class="affinities" id="secondary-affinities"></div>
        <div class="affinity-controls" style="margin-top: 15px;"><label>Tertiary Stats</label><select
            id="add-tertiary"></select></div>
        <div class="affinities" id="tertiary-affinities"></div>
      </div>
    </div>

    <div id="hp-speed"></div>

    <div class="equipment-section">
      <h3>Equipment</h3>
      <div class="equipment-grid">
        <div class="equipment-row">
          <div class="derived-stat attack">
            <div class="derived-stat-formula">
              <span class="fraction">
                <span class="top" id="attack-formula-top"></span>
                <span class="bottom" id="attack-formula-bot"></span>
              </span>
              <span id="attack-formula"></span>
            </div>
            <div class="derived-stat-result" id="derived-attack-result">0</div>
          </div>
          <div class="equipment-slots-row">
            <div class="slot" id="weapon1-slot" title="Weapon Slot 1"></div>
            <div class="slot" id="armor-slot" title="Armor"></div>
            <div class="slot" id="weapon2-slot" title="Weapon Slot 2"></div>
          </div>
        </div>
        <div class="equipment-row">
          <div class="derived-stat defense">
            <div class="derived-stat-formula">
              <span class="fraction">
                <span class="top" id="defense-formula-top"></span>
                <span class="bottom" id="defense-formula-bot"></span>
              </span>
              <span id="defense-formula"></span>
            </div>
            <div class="derived-stat-result" id="derived-defense-result">0</div>
          </div>
          <div class="equipment-slots-row">
            <div class="slot" id="accessory1-slot" title="Accessory 1"></div>
            <div class="slot" id="accessory2-slot" title="Accessory 2"></div>
          </div>
        </div>
      </div>
    </div>

    <h3>Stats</h3>
    <table class="stats-table" id="stats-table">
      <thead>
        <tr>
          <th>Stat</th>
          <th>Value</th>
          <th>+/-</th>
        </tr>
      </thead>
      <tbody id="stats-body"></tbody>
    </table>

    <div class="skill-section" id="skill-section"></div>

    <div id="skill-library-modal" class="modal-backdrop">
      <div class="modal-header">
        <h3 id="skill-library-title">Skill Library</h3>
        <button onclick="closeSkillLibrary()">Close</button>
      </div>
      <input type="text" id="skill-search" class="library-search" placeholder="Search skills...">
      <div class="modal-grid" id="skill-library-grid"></div>
    </div>
    <div id="equipment-library-modal" class="modal-backdrop">
      <div class="modal-header">
        <h3 id="equipment-modal-title">Equipment Library</h3>
        <button onclick="closeEquipmentModal()">Close</button>
      </div>
      <input type="text" id="equipment-search" class="library-search" placeholder="Search equipment...">
      <div class="modal-grid" id="equipment-library-grid"></div>
    </div>
    <div id="skill-info-modal" class="modal-backdrop">
      <div class="modal-header">
        <h3 id="skill-info-title">Skill Details</h3>
        <button onclick="closeSkillInfoModal()">Close</button>
      </div>
      <div id="skill-info-modal-content"></div>
    </div>
    <div id="tooltip"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>
  <script>

    // --- ADMIN CONFIG ---
    const ADMIN_UID = "5pNCkPPJblRfKPvTofqa4kwENJQ2";

    // --- FIREBASE SETUP ---
    const firebaseConfig = {
      apiKey: "AIzaSyCr08RHyYpKBy3omDUtSmYYr3KkXxx30E4",
      authDomain: "tog-charactersheet.firebaseapp.com",
      projectId: "tog-charactersheet",
      storageBucket: "tog-charactersheet.firebasestorage.app",
      messagingSenderId: "915406998560",
      appId: "1:915406998560:web:4edbb2e3deb9d70c0a4045",
      measurementId: "G-ZMQF30F2FC"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- GLOBAL STATE ---
    const stats = ["Strength", "Shinsu Control", "Shinsu Endurance", "Perception", "Willpower", "Technique", "Insight", "Authority"];
    const state = {
      isDirty: false,
      saveTimeout: null,
      ownedItems: [], // New: tracks owned item IDs
      // ... (rest of state properties)
      statValues: {},
      manualStatPoints: {},
      skillsByTier: { 1: [], 2: [], 3: [], 4: [], 5: [] },
      skillBonuses: {},
      currentSkillEdit: { tier: null, index: null },
      skillLibrary: [],
      equipmentLibrary: [],
      currentEquipmentEdit: null,
      availableStatPoints: 0,
      availableSkillPoints: 0,
      bonusSkillPoints: 0,
      usedSkillPoints: 0,
      affinities: { primary: [], secondary: [], tertiary: [] },
      equipment: { weapon1: null, weapon2: null, armor: null, accessory1: null, accessory2: null },
      selectedWeaponSlot: null
    };

    // --- AUTOSAVE SYSTEM ---
    function queueAutoSave() {
      state.isDirty = true;
      clearTimeout(state.saveTimeout); // Clear previous timeout
      state.saveTimeout = setTimeout(() => {
        if (state.isDirty) {
          saveCharacter();
          state.isDirty = false;
        }
      }, 2000); // Save 2 seconds after the last change
    }

    function handleInputChange() {
      updateFromTextbox();
      queueAutoSave();
    }

    // --- AUTH & DATA MANAGEMENT ---
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .catch(error => console.error("Login error", error));
    }

    function signOut() {
      auth.signOut();
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("user-info").textContent = `Logged in as ${user.displayName}`;
        document.getElementById("logoutBtn").style.display = 'inline-block';
        document.querySelectorAll("input, select, button").forEach(el => el.disabled = false);
        loadCharacter();
      } else {
        document.getElementById("user-info").textContent = "Logged out.";
        document.getElementById("logoutBtn").style.display = 'none';
        document.querySelectorAll("input, select, button").forEach(el => {
          if (el.textContent !== "Sign In with Google") el.disabled = true;
        });
        initializeState();
        updateFromTextbox();
      }
    });

    function saveCharacter() {
      const user = auth.currentUser;
      if (!user) return;
      console.log("Autosaving character...", new Date().toLocaleTimeString());
      db.collection("characters").doc(user.uid).set(getCurrentCharacterData())
        .catch(err => console.error("Save failed:", err));
    }

    function loadCharacter() {
      const user = auth.currentUser;
      if (user) {
        db.collection("characters").doc(user.uid).get().then(doc => {
          if (doc.exists) {
            const data = doc.data();
            document.getElementById("char-name").value = data.name || "";
            document.getElementById("char-race").value = data.race || "";
            document.getElementById("char-level").value = data.level || 1;
            document.getElementById("char-floor").value = data.floor || 1;
            document.getElementById("char-position").value = data.position || "Guide";
            state.affinities = data.affinities || { primary: [], secondary: [], tertiary: [] };
            state.skillsByTier = data.skillsByTier || { 1: [], 2: [], 3: [], 4: [], 5: [] };
            state.manualStatPoints = data.manualAdds || Object.fromEntries(stats.map(stat => [stat, 0]));
            state.equipment = data.equipment || { weapon1: null, weapon2: null, armor: null, accessory1: null, accessory2: null };
            state.selectedWeaponSlot = data.selectedWeaponSlot || null;
            state.ownedItems = data.ownedItems || []; // Load owned items
          } else {
            initializeState();
          }
          fetchLibrariesAndUpdate();
        }).catch(err => console.error("Load failed:", err));
      }
    }

    function getCurrentCharacterData() {
      return {
        name: document.getElementById("char-name").value,
        race: document.getElementById("char-race").value,
        position: document.getElementById("char-position").value,
        level: document.getElementById("char-level").value,
        floor: document.getElementById("char-floor").value,
        statMultiplier: document.getElementById("stat-multiplier").value,
        affinities: state.affinities,
        manualAdds: state.manualStatPoints,
        skillsByTier: state.skillsByTier,
        equipment: state.equipment,
        selectedWeaponSlot: state.selectedWeaponSlot,
        ownedItems: state.ownedItems, // Save owned items
      };
    }

    // --- CORE RENDER ORCHESTRATOR ---
    function updateFromTextbox() {
      const level = parseInt(document.getElementById("char-level").value) || 1;

      // Step 1: Calculate base stats from level, position, and affinities.
      calculateBaseStats();

      // Step 2: Apply all passive skill effects
      applyAllSkillEffects();

      // Step 3: Calculate used/available skill and stat points
      const totalAllocatedStatPoints = Object.values(state.manualStatPoints).reduce((sum, val) => sum + val, 0);
      state.availableStatPoints = (level - 1) - totalAllocatedStatPoints;
      calculateUsedSkillPoints();
      state.availableSkillPoints = (level - 1) - state.usedSkillPoints + state.bonusSkillPoints;

      // Step 4: Render all UI components with the new data
      renderAll();
    }

    function renderAll() {
      document.getElementById("available-stat-points").value = state.availableStatPoints;
      document.getElementById("available-skill-points").value = state.availableSkillPoints;
      renderAffinityControls();
      renderStats();
      renderEquipment();
      renderSkillTiers();
      updateDerivedStats();
      renderHpSpeed();
    }

    // --- STATS ---
    function calculateBaseStats() {
      const level = parseInt(document.getElementById("char-level").value) || 1;
      const pos = document.getElementById("char-position").value;
      const priList = state.affinities.primary;
      const secList = state.affinities.secondary;
      const terList = state.affinities.tertiary;

      // Create a temporary object to hold calculated stats
      const calculatedStats = {};

      stats.forEach(stat => {
        let total = 1; // Start with base 1 for all stats
        for (let i = 1; i < level; i++) { // Loop up to level-1 because level 1 is the base
          const rates = getGrowthRatesForLevel(pos, i);
          if (priList.includes(stat)) total += rates.primary;
          if (secList.includes(stat)) total += rates.secondary;
          if (terList.includes(stat)) total += rates.tertiary;
        }
        // Add manually allocated points
        calculatedStats[stat] = total + (state.manualStatPoints[stat] || 0);
      });

      // Update the main state
      state.statValues = calculatedStats;
    }

    function renderStats() {
      const tbody = document.getElementById("stats-body");
      tbody.innerHTML = "";

      const average = stats.reduce((sum, stat) => sum + state.statValues[stat], 0) / stats.length;
      const max = parseFloat(document.getElementById("stat-multiplier").value) * average;

      stats.forEach(stat => {
        const tr = document.createElement("tr");
        const baseValue = state.statValues[stat] || 0;
        const manual = state.manualStatPoints[stat] || 0;
        const skillBonus = state.skillBonuses[stat]?.add || 0;
        const totalValue = baseValue + skillBonus;
        const isCapped = totalValue > max;

        // We add a new "stat-value-cell" class to easily target this element
        tr.innerHTML = `
      <td>${stat}</td>
      <td class="stat-value-cell ${isCapped ? 'stat-capped' : ''}">
          ${totalValue.toFixed(1)}
          <div class="stat-breakdown">(Base ${(baseValue - manual).toFixed(1)} + Manual ${manual} + Skill ${skillBonus.toFixed(1)})</div>
      </td>
      <td><button class="add-stat-btn">+</button><button class="remove-stat-btn">–</button></td>
    `;

        const addBtn = tr.querySelector('.add-stat-btn');
        const removeBtn = tr.querySelector('.remove-stat-btn');

        // Disable button only if there are no stat points available
        if (state.availableStatPoints <= 0) {
          addBtn.disabled = true;
        }

        addBtn.onclick = () => {
          // Check for the cap inside the click event now
          if (state.availableStatPoints > 0) {
            if (totalValue + 1 <= Math.floor(max)) {
              // Success: Increase the stat
              state.manualStatPoints[stat]++;
              updateFromTextbox();
            } else {
              // Failure: Trigger the flash effect on the table cell
              const statCell = tr.querySelector('.stat-value-cell');
              statCell.classList.add('stat-flash-error');
              // Remove the class after the animation finishes
              setTimeout(() => {
                statCell.classList.remove('stat-flash-error');
              }, 500);
            }
          }
        };

        removeBtn.onclick = () => {
          if (state.manualStatPoints[stat] > 0) {
            state.manualStatPoints[stat]--;
            updateFromTextbox();
          }
        };

        tbody.appendChild(tr);
      });
    }

    // --- EQUIPMENT ---
    function renderEquipment() {
      const allSlots = ["weapon1", "weapon2", "armor", "accessory1", "accessory2"];
      const tooltip = document.getElementById('tooltip');

      allSlots.forEach(slotKey => {
        const el = document.getElementById(`${slotKey}-slot`);
        const item = state.equipment[slotKey];

        el.innerHTML = "";
        el.onmouseover = (e) => showTooltip(e, item);
        el.onmouseout = hideTooltip;

        if (item) {
          const img = document.createElement("img");
          img.src = item.image || "https://dummyimage.com/100x100/333/aaa&text=?";
          img.alt = item.name || slotKey;
          img.className = "item-image";
          el.appendChild(img);
        }

        const changeIcon = document.createElement("div");
        changeIcon.className = "change-item-icon";
        changeIcon.textContent = item ? '⇄' : '+';
        changeIcon.onclick = (e) => { e.stopPropagation(); openEquipmentModal(slotKey); };
        el.appendChild(changeIcon);

        if (slotKey === "weapon1" || slotKey === "weapon2") {
          el.classList.toggle("selected-weapon", state.selectedWeaponSlot === slotKey);
          el.onclick = () => {
            if (state.equipment[slotKey]) {
              state.selectedWeaponSlot = (state.selectedWeaponSlot === slotKey) ? null : slotKey;
              updateDerivedStats();
              renderEquipment();
            }
          };
        }
      });
    }

    function selectEquipment(item) {
      if (!state.currentEquipmentEdit) return;

      // New: Prevent equipping the same accessory twice
      if (item.type === 'accessory') {
        const otherSlot = state.currentEquipmentEdit === 'accessory1-slot' ? 'accessory2' : 'accessory1';
        if (state.equipment[otherSlot] && state.equipment[otherSlot].id === item.id) {
          alert("You cannot equip the same accessory twice.");
          return;
        }
      }

      equipItem(state.currentEquipmentEdit.replace('-slot', ''), item);
      closeEquipmentModal();
    }

    function equipItem(slot, item) {
      state.equipment[slot] = item;
      if (item && item.type === 'weapon' && !state.selectedWeaponSlot) {
        state.selectedWeaponSlot = slot;
      }
      if (!item && state.selectedWeaponSlot === slot) {
        state.selectedWeaponSlot = null;
      }
      handleInputChange();
    }

    function renderEquipmentLibrary() {
      const grid = document.getElementById("equipment-library-grid");
      const searchTerm = document.getElementById("equipment-search").value.toLowerCase();
      grid.innerHTML = "";

      const slotType = state.currentEquipmentEdit.includes('weapon') ? 'weapon' : (state.currentEquipmentEdit.includes('armor') ? 'armor' : 'accessory');
      const filteredItems = state.equipmentLibrary
        .filter(item => item.type === slotType && (item.name.toLowerCase().includes(searchTerm)));

      filteredItems.sort((a, b) => {
        const scoreA = getItemScore(a);
        const scoreB = getItemScore(b);
        return scoreB - scoreA;
      });

      filteredItems.forEach(item => {
        const card = document.createElement("div");
        card.className = "item-card";
        const isOwned = state.ownedItems.includes(item.id);

        // Using SVG icons instead of "..."
        const infoIconSVG = `<svg class="info-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" fill="currentColor"></path></svg>`;
        const ownedIconSVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`;

        let buttonsHTML = `<div onclick='event.stopPropagation(); openItemInfoModal(${JSON.stringify(item).replace(/'/g, "&apos;")})'>${infoIconSVG}</div>`;

        if (item.isDiscovered) {
          buttonsHTML += `<div class="card-button ${isOwned ? 'owned' : ''}" onclick="event.stopPropagation(); toggleItemOwnership('${item.id}')">${ownedIconSVG}</div>`;
        }
        if (!item.isDiscovered && auth.currentUser && auth.currentUser.uid === ADMIN_UID) {
          buttonsHTML += `<div class="card-button discover-btn" onclick="event.stopPropagation(); discoverItem('${item.id}')">D</div>`;
        }

        if (item.isDiscovered) {
          card.innerHTML = buttonsHTML + `<img src="${item.image}" alt="${item.name}" /><div class="item-name">${item.name}</div>`;
          card.onclick = () => selectEquipment(item);
        } else {
          card.classList.add("undiscovered");
          card.innerHTML = buttonsHTML + `<img src="https://dummyimage.com/100x100/333/aaa&text=?" alt="Undiscovered" /><div class="item-name">Undiscovered</div>`;
        }
        grid.appendChild(card);
      });
    }

    function renderSkillLibrary() {
      const grid = document.getElementById("skill-library-grid");
      const searchTerm = document.getElementById("skill-search").value.toLowerCase();
      grid.innerHTML = "";
      const { tier } = state.currentSkillEdit;
      const position = document.getElementById("char-position").value;

      // Using SVG icon instead of "..."
      const infoIconSVG = `<svg class="info-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" fill="currentColor"></path></svg>`;

      state.skillLibrary
        .filter(skill =>
          skill.positionTags.includes(position) &&
          getSkillTier(skill, 1) <= tier &&
          (skill.name.toLowerCase().includes(searchTerm) || skill.skillType?.toLowerCase().includes(searchTerm))
        )
        .forEach(skill => {
          const card = document.createElement("div");
          card.className = "skill-card";
          const skillJSON = JSON.stringify(skill).replace(/'/g, "&apos;");
          card.innerHTML = `<div onclick='event.stopPropagation(); openSkillInfoModal(${skillJSON})'>${infoIconSVG}</div>
                        <img src="${skill.icon}" alt="${skill.name}" onclick='selectSkill(${skillJSON})' />
                        <div class="skill-name">${skill.name}</div>`;
          grid.appendChild(card);
        });
    }

    function getItemScore(item) {
      if (Object.values(state.equipment).some(eq => eq && eq.id === item.id)) return 4; // Equipped
      if (state.ownedItems.includes(item.id)) return 3; // Owned
      if (item.isDiscovered) return 2; // Discovered
      return 1; // Undiscovered
    }

    function toggleItemOwnership(itemId) {
      const itemIndex = state.ownedItems.indexOf(itemId);
      if (itemIndex > -1) {
        state.ownedItems.splice(itemIndex, 1);
      } else {
        state.ownedItems.push(itemId);
      }
      renderEquipmentLibrary();
      queueAutoSave();
    }

    async function discoverItem(itemId) {
      await db.collection("items").doc(itemId).update({ isDiscovered: true });
      const localItem = state.equipmentLibrary.find(i => i.id === itemId);
      if (localItem) localItem.isDiscovered = true;
      renderEquipmentLibrary();
    }

    async function fetchSkillLibrary() {
      try {
        const snapshot = await db.collection("skills").get();
        state.skillLibrary = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error("Error fetching skill library from Firestore:", error);
        state.skillLibrary = [];
        alert("Could not load skills from the database.");
      }
    }

    async function fetchEquipmentLibrary() {
      try {
        const snapshot = await db.collection("items").get();
        state.equipmentLibrary = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error("Error fetching equipment from Firestore:", error);
        state.equipmentLibrary = [];
        alert("Could not load equipment from the database.");
      }
    }

    // --- SKILLS ---
    function renderSkillTiers() {
      const container = document.getElementById("skill-section");
      container.innerHTML = "";
      for (let tier = 1; tier <= 5; tier++) {
        const tierDiv = document.createElement("div");
        tierDiv.className = "tier-section";
        tierDiv.innerHTML = `<div class="tier-header"><h4>Tier ${tier}</h4><button onclick="addSkillSlot(${tier})">+ Slot</button></div><div class="skill-slots" id="tier-${tier}-slots"></div>`;
        const slotGrid = tierDiv.querySelector(`#tier-${tier}-slots`);
        const skillsInTier = state.skillsByTier[tier] || [];
        skillsInTier.forEach((skill, index) => {
          const slot = document.createElement("div");
          slot.className = "skill-slot";
          if (!skill) {
            slot.classList.add("empty");
            slot.onclick = () => openSkillLibrary(tier, index);
          } else {
            // Updated to use SVG icon and new level badge style
            slot.innerHTML = `<img src="${skill.icon}" alt="${skill.name}">
           <div class="skill-level-badge">${skill.level || 0}</div>
           <svg class="info-icon" onclick="event.stopPropagation(); openSkillInfoModal(state.skillsByTier[${tier}][${index}], ${tier}, ${index})" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" fill="currentColor"></path></svg>`;
          }
          slotGrid.appendChild(slot);
        });
        container.appendChild(tierDiv);
      }
    }

    function selectSkill(skillData) {
      const { tier, index } = state.currentSkillEdit;
      if (tier !== null && index !== null) {
        const newSkillInstance = JSON.parse(JSON.stringify(skillData));
        newSkillInstance.level = 0; // Equip at level 0
        state.skillsByTier[tier][index] = newSkillInstance;
        openSkillInfoModal(state.skillsByTier[tier][index], tier, index);
        closeSkillLibrary();
        handleInputChange(); // Autosave the change
      }
    }
    function openSkillLibrary(tier, index) {
      state.currentSkillEdit = { tier, index };
      document.getElementById("skill-library-title").textContent = `Skill Library (Tier ${tier} Slot)`;
      document.getElementById("skill-library-modal").classList.add("active");

      // Handle the new search bar
      const searchInput = document.getElementById('skill-search');
      searchInput.value = ''; // Clear search on open
      searchInput.addEventListener('input', renderSkillLibrary);

      renderSkillLibrary();
    }

    function closeSkillLibrary() {
      document.getElementById("skill-library-modal").classList.remove("active");
      // Important: Remove the listener to avoid it running when the modal is closed
      document.getElementById('skill-search').removeEventListener('input', renderSkillLibrary);
    }

    function openSkillInfoModal(skillData, tier = null, index = null) {
      const modal = document.getElementById("skill-info-modal");
      document.getElementById("skill-info-title").textContent = skillData.name;
      const content = document.getElementById("skill-info-modal-content");

      // THIS BLOCK WAS MISSING - It defines controlsHTML
      let controlsHTML = '';
      if (tier !== null && index !== null) {
        const skill = state.skillsByTier[tier][index];
        const nextLevel = (skill.level || 0) + 1;
        const canLevelUp = nextLevel <= skill.maxLevel && state.availableSkillPoints >= (skill.costPerLevel[skill.level || 0] || 999) && getSkillTier(skill, nextLevel) <= tier;
        controlsHTML = `<div class="level-up-controls">
            <h3>Current Level: ${skill.level || 0} / ${skill.maxLevel}</h3>
            <button onclick="levelUpSkill(${tier}, ${index})" ${!canLevelUp ? 'disabled' : ''}>Level Up (Cost: ${skill.costPerLevel[skill.level || 0] || 'N/A'} SP)</button>
            <button onclick="delevelSkill(${tier}, ${index})" ${!skill.level || skill.level === 0 ? 'disabled' : ''}>De-level</button>
            <button onclick="unlearnSkill(${tier}, ${index})" style="background-color: #8b0000;">Unlearn</button>
        </div>`;
      }

      const hasEffects = skillData.effects && skillData.effects.length > 0;
      const hasDamage = skillData.damagePerLevel && skillData.damagePerLevel.length > 0;

      let tableHeader = `<tr><th>Lvl</th><th>Cost</th><th>Tier</th>`;
      if (hasDamage) tableHeader += `<th>Damage</th>`;
      if (hasEffects) tableHeader += `<th>Effect</th>`;
      tableHeader += `</tr>`;

      let tableBody = '';
      for (let i = 1; i <= skillData.maxLevel; i++) {
        const isCurrent = skillData.level === i;
        let row = `<tr class="${isCurrent ? 'current-level-row' : ''}">
                       <td>${i}</td>
                       <td>${skillData.costPerLevel[i - 1]}</td>
                       <td>${getSkillTier(skillData, i)}</td>`;
        if (hasDamage) {
          row += `<td>${skillData.damagePerLevel[i - 1] || '-'}</td>`;
        }
        if (hasEffects) {
          const effect = skillData.effects.find(e => e.level === i);
          let effectText = '-';
          if (effect) {
            effectText = `${effect.stat}: ${effect.type === 'add' ? '+' : 'x'}${effect.value}`;
            if (effect.stat2) effectText += `, ${effect.stat2}: +${effect.value2}`;
          }
          row += `<td>${effectText}</td>`;
        }
        row += `</tr>`;
        tableBody += row;
      }

      content.innerHTML = `
            <div class="left-panel">
                <img src="${skillData.icon}" alt="${skillData.name}">
                <p><strong>Type:</strong> ${skillData.skillType || 'N/A'}</p>
                <p>${skillData.description}</p>
                <p><strong>Positions:</strong> ${skillData.positionTags.join(', ')}</p>
                ${controlsHTML}
            </div>
            <div class="right-panel">
                <table class="level-table">${tableHeader}${tableBody}</table>
            </div>`;

      modal.classList.add("active");
    }

    function levelUpSkill(tier, index) {
      const skill = state.skillsByTier[tier][index];
      const cost = skill.costPerLevel[skill.level || 0];
      const nextLevel = (skill.level || 0) + 1;
      if (nextLevel <= skill.maxLevel && state.availableSkillPoints >= cost && getSkillTier(skill, nextLevel) <= tier) {
        skill.level = nextLevel;
        handleInputChange(); // Autosave
        openSkillInfoModal(skill, tier, index); // Refresh modal
      }
    }

    function delevelSkill(tier, index) {
      const skill = state.skillsByTier[tier][index];
      if (skill.level > 0) {
        skill.level--;
        handleInputChange(); // Autosave
        openSkillInfoModal(skill, tier, index);
      }
    }

    function unlearnSkill(tier, index) {
      state.skillsByTier[tier][index] = null;
      closeSkillInfoModal();
      handleInputChange(); // Autosave
    }

    // --- EVENT LISTENERS FOR SEARCH BARS ---
    document.getElementById('skill-search').addEventListener('input', renderSkillLibrary);
    document.getElementById('equipment-search').addEventListener('input', renderEquipmentLibrary);

    function initializeState() {
      state.statValues = Object.fromEntries(stats.map(stat => [stat, 1]));
      state.manualStatPoints = Object.fromEntries(stats.map(stat => [stat, 0]));
    }

    function getGrowthTable() {
      // This table defines stat growth per level based on class
      return {
        Guide: [{ range: [1, 10], primary: 1, secondary: 0.5, tertiary: 0.5 }, { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 }, { range: [26, 50], primary: 1.5, secondary: 1, tertiary: 0.5 }, { range: [51, 80], primary: 2, secondary: 1.5, tertiary: 1 }, { range: [81, 110], primary: 2.5, secondary: 2, tertiary: 1 }, { range: [111, 140], primary: 3, secondary: 2, tertiary: 1.5 }, { range: [141, 170], primary: 3, secondary: 2.5, tertiary: 2 }, { range: [171, Infinity], primary: 4, secondary: 3, tertiary: 3 }],
        Fisherman: [{ range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 }, { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 }, { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 }, { range: [51, 80], primary: 2, secondary: 2, tertiary: 1 }, { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 }, { range: [111, 140], primary: 3, secondary: 2, tertiary: 2 }, { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 }, { range: [171, Infinity], primary: 4, secondary: 3, tertiary: 3 }],
        "Spear Bearer": [{ range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 }, { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 }, { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 }, { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 }, { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 }, { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 }, { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 }, { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }],
        "Wave Controller": [{ range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 }, { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 }, { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 }, { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 }, { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 }, { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 }, { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 }, { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }],
        "Light Bearer": [{ range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 }, { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 }, { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 }, { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 }, { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 }, { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 }, { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 }, { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }],
        Anima: [{ range: [1, 10], primary: 2, secondary: 1, tertiary: 0.5 }, { range: [11, 25], primary: 2.5, secondary: 1, tertiary: 0.5 }, { range: [26, 50], primary: 3, secondary: 1, tertiary: 0.5 }, { range: [51, 80], primary: 3.5, secondary: 1.5, tertiary: 1 }, { range: [81, 110], primary: 4, secondary: 1.5, tertiary: 1 }, { range: [111, 140], primary: 5, secondary: 2, tertiary: 1.5 }, { range: [141, 170], primary: 6, secondary: 2, tertiary: 1.5 }, { range: [171, Infinity], primary: 6, secondary: 2, tertiary: 2 }]
      };
    }

    function getGrowthRatesForLevel(position, level) {
      const table = getGrowthTable()[position] || [];
      return table.find(r => level >= r.range[0] && level <= r.range[1]) || { primary: 0, secondary: 0, tertiary: 0 };
    }

    function updateDerivedStats() {
      const eq = state.equipment;
      let attack = 0;
      let defense = 0;

      const selectedWeaponSlot = state.selectedWeaponSlot;
      if (selectedWeaponSlot && eq[selectedWeaponSlot]) {
        const weapon = eq[selectedWeaponSlot];
        const baseStat = state.statValues[weapon.stat] + (state.skillBonuses[weapon.stat]?.add || 0);
        attack = Math.floor(baseStat / 5) + (weapon.modifier || 0);
        document.getElementById("attack-formula-top").textContent = `(${baseStat.toFixed(1)} ${weapon.stat})`;
        document.getElementById("attack-formula-bot").textContent = `5`;
        document.getElementById("attack-formula").innerHTML = ` &nbsp;+&nbsp; ${weapon.modifier} Mod &nbsp;=&nbsp;`;
      } else {
        document.getElementById("attack-formula-top").textContent = "";
        document.getElementById("attack-formula-bot").textContent = "";
        document.getElementById("attack-formula").innerHTML = "";
      }

      if (eq.armor) {
        const armor = eq.armor;
        const baseStat = state.statValues[armor.stat] + (state.skillBonuses[armor.stat]?.add || 0);
        defense = Math.floor(baseStat / 5) + (armor.modifier || 0);
        document.getElementById("defense-formula-top").textContent = `(${baseStat.toFixed(1)} ${armor.stat})`;
        document.getElementById("defense-formula-bot").textContent = `5`;
        document.getElementById("defense-formula").innerHTML = ` &nbsp;+&nbsp; ${armor.modifier} Mod &nbsp;=&nbsp;`;
      } else {
        document.getElementById("defense-formula-top").textContent = "";
        document.getElementById("defense-formula-bot").textContent = "";
        document.getElementById("defense-formula").innerHTML = "";
      }

      // Corrected to update the new result divs
      document.getElementById("derived-attack-result").textContent = `${attack} Attack`;
      document.getElementById("derived-defense-result").textContent = `${defense} Defense`;
    }

    async function fetchLibrariesAndUpdate() {
      await fetchEquipmentLibrary();
      await fetchSkillLibrary();
      updateFromTextbox();
    }

    function showTooltip(event, item) {
      if (!item) return;
      const tooltip = document.getElementById('tooltip');
      const html = `
            <div class="tooltip-name">${item.name}</div>
            <div class="tooltip-stats">
                Type: ${item.type}<br>
                Stat: ${item.stat} | Modifier: ${item.modifier}
            </div>
            <div class="tooltip-effect">${item.specialEffect || 'No special effect.'}</div>
        `;
      tooltip.innerHTML = html;
      tooltip.style.display = 'block';
      tooltip.style.left = `${event.pageX + 15}px`;
      tooltip.style.top = `${event.pageY + 15}px`;
    }

    function hideTooltip() {
      document.getElementById('tooltip').style.display = 'none';
    }

    function renderHpSpeed() {
      const floor = parseInt(document.getElementById("char-floor").value);
      const level = parseInt(document.getElementById("char-level").value);
      const se = (state.statValues["Shinsu Endurance"] || 0) + (state.skillBonuses["Shinsu Endurance"]?.add || 0);
      const str = (state.statValues["Strength"] || 0) + (state.skillBonuses["Strength"]?.add || 0);
      const wp = (state.statValues["Willpower"] || 0) + (state.skillBonuses["Willpower"]?.add || 0);

      const movePenalty = Math.max(0, 2 * floor - se);
      let speed = 6 + level - movePenalty + (state.skillBonuses['Movement Speed']?.add || 0);
      let hp = (3 * se + 2 * str + 1.5 * wp + level * (2 + Math.floor(level / 25))) + (state.skillBonuses['HP']?.add || 0);

      // Updated to include spans with the new class for yellow accents
      document.getElementById("hp-speed").innerHTML =
        `<span class="accent-label">HP:</span> ${Math.round(hp)}<br><span class="accent-label">Movement Speed:</span> ${speed}`;
    }

    function renderAffinityControls() {
      ["primary", "secondary", "tertiary"].forEach(type => {
        const container = document.getElementById(`${type}-affinities`);
        const select = document.getElementById(`add-${type}`);
        container.innerHTML = "";

        // Populate the dropdown with only unselected stats
        select.innerHTML = "<option value=''>+ Add</option>" + stats
          .filter(stat => !state.affinities.primary.includes(stat) && !state.affinities.secondary.includes(stat) && !state.affinities.tertiary.includes(stat))
          .map(stat => `<option value="${stat}">${stat}</option>`).join("");

        // Render the tags for currently selected affinities
        (state.affinities[type] || []).forEach(stat => {
          const div = document.createElement("div");
          div.innerHTML = `${stat} <span class="remove-affinity">x</span>`;

          div.querySelector('.remove-affinity').onclick = () => {
            state.affinities[type] = state.affinities[type].filter(s => s !== stat);
            updateFromTextbox();
          };
          container.appendChild(div);
        });

        // Handle adding a new affinity from the dropdown
        select.onchange = e => {
          const val = e.target.value;
          if (val && !(state.affinities[type] || []).includes(val)) {
            if (!state.affinities[type]) state.affinities[type] = [];
            state.affinities[type].push(val);
            updateFromTextbox();
          }
          e.target.value = ''; // Reset dropdown after selection
        };
      });
    }

    function addSkillPoint() {
      state.bonusSkillPoints++;
      updateFromTextbox();
    }

    function levelUp() {
      document.getElementById("char-level").value = parseInt(document.getElementById("char-level").value) + 1;
      updateFromTextbox();
    }

    function resetCharacter() {
      if (!confirm("Are you sure? This will delete the character from the database.")) return;
      const user = auth.currentUser;
      if (user) {
        db.collection("characters").doc(user.uid).delete().then(() => {
          location.reload(); // Easiest way to reset the sheet to its initial state
        }).catch(err => console.error("Failed to delete character:", err));
      }
    }

    function calculateUsedSkillPoints() {
      let total = 0;
      for (const tier in state.skillsByTier) {
        for (const skill of state.skillsByTier[tier]) {
          if (skill && skill.level > 0) {
            total += skill.costPerLevel.slice(0, skill.level).reduce((a, b) => a + b, 0);
          }
        }
      }
      state.usedSkillPoints = total;
    }

    function applyAllSkillEffects() {
      state.skillBonuses = {};
      for (const tier in state.skillsByTier) {
        for (const skill of state.skillsByTier[tier]) {
          if (!skill || skill.level === 0 || !skill.effects) continue;

          const currentLevelEffect = skill.effects.find(e => e.level === skill.level);
          if (currentLevelEffect) {
            [{ stat: 'stat', type: 'type', value: 'value' }, { stat: 'stat2', type: 'type2', value: 'value2' }].forEach(map => {
              const stat = currentLevelEffect[map.stat];
              const type = currentLevelEffect[map.type];
              const value = currentLevelEffect[map.value];
              if (!stat || !type || value === undefined) return;
              if (!state.skillBonuses[stat]) state.skillBonuses[stat] = { add: 0, mul: 1 };
              if (type === 'add') state.skillBonuses[stat].add += value;
              if (type === 'mul') state.skillBonuses[stat].mul *= value;
            });
          }
        }
      }
    }

    function getSkillTier(skill, level) {
      if (!skill.tierByLevel) return 1;
      return [...skill.tierByLevel].reverse().find(t => level >= t.level)?.tier || 1;
    }

    function addSkillSlot(tier) {
      if (!state.skillsByTier[tier]) state.skillsByTier[tier] = [];
      state.skillsByTier[tier].push(null);
      renderSkillTiers();
    }

    function closeSkillLibrary() { document.getElementById("skill-library-modal").classList.remove("active"); }

    function openEquipmentModal(slotKey) {
      state.currentEquipmentEdit = slotKey;
      const modal = document.getElementById("equipment-library-modal");
      const title = slotKey.replace('slot', '').replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
      document.getElementById("equipment-modal-title").textContent = `Equip to ${title}`;
      modal.classList.add("active");
      renderEquipmentLibrary();
    }

    // This is a placeholder function to prevent errors until a full item modal is designed.
    function openItemInfoModal(itemData) {
      alert(`Item Info:\nName: ${itemData.name}\nType: ${itemData.type}\nEffect: ${itemData.specialEffect || 'None'}`);
    }

    function closeEquipmentModal() { document.getElementById("equipment-library-modal").classList.remove("active"); }

    function closeSkillInfoModal() { document.getElementById("skill-info-modal").classList.remove("active"); }

    window.onload = () => {
      initializeState();
    };


  </script>
</body>

</html>