<!DOCTYPE html>
<html>

<head>

  <title>Character Sheet</title>
  <style>
    h2 {
      text-align: center;
    }

    .row {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .col {
      flex: 1 1 45%;
      margin: 10px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .stats-table th,
    .stats-table td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }

    .btn-row button {
      margin-right: 10px;
    }

    #hp-speed {
      margin-top: 20px;
      font-size: 1.1em;
    }

    .affinities {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 5px;
    }

    .affinities div {
      background-color: #3d3d5c;
      color: #e0e0ff;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .affinities div:hover {
      background-color: #50507a;
    }

    .stat-display {
      font-size: 1.2em;
    }

    .stat-breakdown {
      font-size: 0.85em;
      color: #555;
    }

    body {
      background-color: #1e1e2f;
      color: #e0e0e0;
    }

    .container {
      background-color: #2a2a40;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px #00000080;
    }

    input[type="text"],
    input[type="number"],
    select,
    button,
    textarea {
      background-color: #3a3a55;
      color: #ffffff;
      border: 1px solid #555;
      border-radius: 4px;
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #8888ff;
      box-shadow: 0 0 5px #8888ff50;
    }

    button {
      background-color: #444466;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    button:hover {
      background-color: #555588;
    }

    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
      color: #ccc;
    }

    h2 {
      color: #ffffff;
      text-align: center;
    }

    .stat-label {
      font-weight: bold;
      margin-right: 5px;
    }

    .stat-breakdown {
      font-size: 0.85em;
      color: #aaaaaa;
      margin-left: 5px;
    }

    .equipment-section {
      background-color: #1f1f2a;
      border-radius: 8px;
      padding: 16px;
      margin-top: 14px;
    }

    .equipment-section h3 {
      color: #ccc;
      text-align: center;
      margin-bottom: 10px;
    }

    .equipment-grid {
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .slot {
      width: 110px;
      height: 110px;
      background-color: #333444;
      border: 2px dashed #666;
      border-radius: 6px;
      background-size: cover;
      background-position: center;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .slot:hover {
      border-color: #888;
    }

    /* Skill Sections */
    .skill-section {
      margin-top: 20px;
      padding: 10px;
      background-color: #1f1f1f;
      border-radius: 8px;
    }

    /* Tier Sections */
    .tier-section {
      margin-bottom: 15px;
      border-top: 1px solid #444;
      padding-top: 10px;
    }

    /* Tier Header */
    .tier-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    /* Skill Slot Grid */
    .skill-slots {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* Individual Skill Slot */
    .skill-slot {
      width: 48px;
      height: 48px;
      border: 2px dashed #555;
      background-color: #2c2c2c;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }

    .skill-slot:hover {
      background-color: #3a3a3a;
    }

    .skill-slot img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Empty Skill Slot Indicator */
    .skill-slot.empty::after {
      content: '+';
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    #skill-library-modal {
      position: fixed;
      top: 5%;
      left: 5%;
      width: 90%;
      height: 90%;
      background-color: #1e1e1e;
      border: 2px solid #555;
      border-radius: 8px;
      z-index: 999;
      display: none;
      flex-direction: column;
      padding: 20px;
      overflow: auto;
    }

    #skill-library-modal.active {
      display: flex;
    }

    .skill-library-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .skill-library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
    }

    .skill-card {
      background-color: #2a2a2a;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .skill-card:hover {
      background-color: #333;
    }

    .skill-card img {
      width: 100%;
      height: 100px;
      object-fit: contain;
      margin-bottom: 8px;
    }

    .skill-card .skill-name {
      font-weight: bold;
      margin-bottom: 4px;
    }

    .skill-card .skill-description {
      font-size: 12px;
      color: #aaa;
    }

    .selected-weapon {
      outline: 3px solid #f5d442;
      box-shadow: 0 0 10px #f5d442;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Character Sheet</h2>

    <div style="margin-bottom: 10px;">
      <button onclick="signInWithGoogle()">Sign In with Google</button>
      <button onclick="signOut()" id="logoutBtn" style="display:none;">Sign Out</button>
      <button onclick="saveCharacter()">Save Character</button>
      <button onclick="resetCharacter()">Reset Character</button>
      <span id="user-info" style="margin-left: 10px;"></span>
    </div>

    <div class="row">
      <div class="col">
        <label>Name</label>
        <input type="text" id="char-name">

        <label>Race</label>
        <input type="text" id="char-race">

        <label>Position</label>
        <select id="char-position" onchange="updateFromTextbox()">
          <option value="Guide">Guide</option>
          <option value="Fisherman">Fisherman</option>
          <option value="Spear Bearer">Spear Bearer</option>
          <option value="Wave Controller">Wave Controller</option>
          <option value="Light Bearer">Light Bearer</option>
          <option value="Anima">Anima</option>
        </select>

        <label>Primary Stats</label>
        <div class="affinities" id="primary-affinities"></div>
        <select id="add-primary"></select>

        <label>Secondary Stats</label>
        <div class="affinities" id="secondary-affinities"></div>
        <select id="add-secondary"></select>

        <label>Tertiary Stats</label>
        <div class="affinities" id="tertiary-affinities"></div>
        <select id="add-tertiary"></select>

        <label>Level</label>
        <input type="number" id="char-level" min="1" value="1" onchange="updateFromTextbox()">

        <label>Floor</label>
        <input type="number" id="char-floor" min="1" value="1" onchange="renderHpSpeed()">

        <label>Stat Point Multiplier</label>
        <input type="number" id="stat-multiplier" min="1" step="0.1" value="1.5">
      </div>

      <div class="col">
        <label>Available Stat Points</label>
        <input type="number" id="available-stat-points" value="0" readonly>

        <label>Available Skill Points</label>
        <input type="number" id="available-skill-points" value="0" readonly>

        <div class="btn-row">
          <button onclick="levelUp()">Level Up</button>
          <button onclick="addSkillPoint()">+1 Skill Point</button>
        </div>
      </div>
    </div>

    <div id="hp-speed"></div>



    <!-- Add this inside your .container, after base stats -->
    <div class="equipment-section">
      <h3>Equipment</h3>
      <div id="derived-stats">
        <p>Attack: <span id="derived-attack">0</span></p>
        <p>Defense: <span id="derived-defense">0</span></p>
      </div>
      <div class="equipment-grid">
        <div class="slot" id="weapon1-slot" title="Weapon Slot 1"></div>
        <div class="slot" id="armor-slot" title="Armor"></div>
        <div class="slot" id="weapon2-slot" title="Weapon Slot 2"></div>
        <div class="slot" id="accessory1-slot" title="Accessory 1"></div>
        <div class="slot" id="accessory2-slot" title="Accessory 2"></div>
      </div>
    </div>


    <h3>Stats</h3>
    <table class="stats-table" id="stats-table">
      <thead>
        <tr>
          <th>Stat</th>
          <th>Value</th>
          <th>+1</th>
        </tr>
      </thead>
      <tbody id="stats-body"></tbody>
    </table>

    <div class="skill-section" id="skill-section">
      <!-- This will be filled by renderSkills() -->
    </div>

    <div id="skill-library-modal">
      <div class="skill-library-header">
        <h3>Skill Library</h3>
        <button onclick="closeSkillLibrary()">Close</button>
      </div>

      <div class="skill-library-grid" id="skill-library-grid">
        <!-- Skill cards rendered here -->
      </div>
    </div>
  </div>

  </script>
  <!-- 1. Firebase SDK Scripts (put just before </body>) -->

  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>

  <script>
    // 2. Your Firebase Project Configuration (from Project Settings > General)
    const firebaseConfig = {
      apiKey: "AIzaSyCr08RHyYpKBy3omDUtSmYYr3KkXxx30E4",
      authDomain: "tog-charactersheet.firebaseapp.com",
      projectId: "tog-charactersheet",
      storageBucket: "tog-charactersheet.firebasestorage.app",
      messagingSenderId: "915406998560",
      appId: "1:915406998560:web:4edbb2e3deb9d70c0a4045",
      measurementId: "G-ZMQF30F2FC"
    };


    // 3. Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();


    // 4. Auth UI Logic
    function signInWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          document.getElementById("user-info").textContent = `Logged in as ${user.displayName}`;
          document.getElementById("logoutBtn").style.display = 'inline-block';
          loadCharacter(); // Auto-load on login
        })
        .catch(error => console.error("Login error", error));
    }


    function signOut() {
      auth.signOut().then(() => {
        document.getElementById("user-info").textContent = "Logged out.";
        document.getElementById("logoutBtn").style.display = 'none';
      });
    }


    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("user-info").textContent = `Logged in as ${user.displayName}`;
        document.getElementById("logoutBtn").style.display = 'inline-block';
        document.querySelectorAll("input, select, button").forEach(el => el.disabled = false);
        loadCharacter();
      } else {
        document.getElementById("user-info").textContent = "Logged out.";
        document.getElementById("logoutBtn").style.display = 'none';
        document.querySelectorAll("input, select, button").forEach(el => {
          if (!el.closest("body > .container > div > button")) el.disabled = true;
        });
      }
    });



    // 5. Save & Load Character
    function getCurrentCharacterData() {
      return {
        level: document.getElementById("char-level").value,
        floor: document.getElementById("char-floor").value,
        name: document.getElementById("char-name").value,
        race: document.getElementById("char-race").value,
        position: document.getElementById("char-position").value,
        affinities: state.affinities,
        stats: state.statValues,
        skillsByTier: state.skillsByTier,
        manualAdds: state.manualStatPoints,
        equipment: state.equipment,
        derivedStats: state.derivedStats,
        selectedWeaponSlot: state.selectedWeaponSlot
      };
    }


    function saveCharacter() {
      const user = auth.currentUser;
      if (user) {
        db.collection("characters").doc(user.uid).set(getCurrentCharacterData())
          .then(() => alert("Character saved!"))
          .catch(err => console.error("Save failed:", err));
      }
    }


    function loadCharacter() {
      const user = auth.currentUser;
      if (user) {
        db.collection("characters").doc(user.uid).get()
          .then(doc => {
            if (doc.exists) {
              const data = doc.data();
              document.getElementById("char-name").value = data.name;
              document.getElementById("char-race").value = data.race;
              document.getElementById("char-level").value = data.level;
              document.getElementById("char-floor").value = data.floor;
              document.getElementById("char-position").value = data.position;
              state.affinities = data.affinities || { primary: [], secondary: [], tertiary: [] };
              state.statValues = data.stats || {};
              state.skillsByTier = data.skillsByTier || { 1: [], 2: [], 3: [], 4: [], 5: [] };
              state.manualStatPoints = data.manualAdds || Object.fromEntries(stats.map(stat => [stat, 0]));
              state.derivedStats = data.derivedStats || { attack: 0, defense: 0 };
              state.equipment = data.equipment || { weapon1: null, weapon2: null, armor: null, accessory1: null, accessory2: null };
              state.selectedWeaponSlot = data.selectedWeaponSlot || null;

              updateDerivedStats();
              updateFromTextbox();
              renderSkills();
            }
          })
          .catch(err => console.error("Load failed:", err));
      }
    }
  </script>

  <script>
    const stats = ["Strength", "Shinsu Control", "Shinsu Endurance", "Perception", "Willpower", "Technique", "Insight", "Authority"];
    const state = {
      statValues: Object.fromEntries(stats.map(stat => [stat, 1])),
      manualStatPoints: Object.fromEntries(stats.map(stat => [stat, 0])),
      statHistory: [],
      skillsByTier: { 1: [], 2: [], 3: [], 4: [], 5: [] },
      currentSkillEdit: { tier: null, index: null },
      skillLibrary: [],
      skillFilter: { position: "", tier: null, search: "" },
      availableStatPoints: 0,
      availableSkillPoints: 0,
      bonusSkillPoints: 0,
      usedSkillPoints: 0,
      affinities: { primary: [], secondary: [], tertiary: [] },
      derivedStats: { attack: 0, defense: 0 },
      equipment: {
        weapon1: null,
        weapon2: null,
        armor: null,
        accessory1: null,
        accessory2: null
      },
      selectedWeaponSlot: null
    };

    function renderAffinityControls() {
      ["primary", "secondary", "tertiary"].forEach(type => {
        const container = document.getElementById(`${type}-affinities`);
        const select = document.getElementById(`add-${type}`);
        container.innerHTML = "";
        select.innerHTML = "<option value=''>+ Add</option>" + stats.map(stat => `<option value="${stat}">${stat}</option>`).join("");

        state.affinities[type].forEach(stat => {
          const div = document.createElement("div");
          div.textContent = stat;
          div.onclick = () => {
            state.affinities[type] = state.affinities[type].filter(s => s !== stat);
            updateFromTextbox();
          };
          container.appendChild(div);
        });

        select.onchange = e => {
          const val = e.target.value;
          if (val && !state.affinities[type].includes(val)) {
            state.affinities[type].push(val);
            updateFromTextbox();
          }
        };
      });
    }

    function renderEquipment() {
      ["weapon1", "weapon2"].forEach(slot => {
        const el = document.getElementById(`${slot}-slot`); // Make sure this ID exists in HTML
        const item = state.equipment[slot];

        el.innerHTML = ""; // Clear old content

        if (item) {
          const img = document.createElement("img");
          img.src = item.image || "default.png";
          img.alt = item.name || "Weapon";
          el.appendChild(img);

          // Highlight selected
          if (state.selectedWeaponSlot === slot) {
            el.classList.add("selected-weapon");
          } else {
            el.classList.remove("selected-weapon");
          }

          // Clicking just sets the selected slot
          el.onclick = () => {
            state.selectedWeaponSlot = (state.selectedWeaponSlot === slot) ? null : slot;
            updateDerivedStats();
            renderEquipment(); // Re-render to update highlight
          };
        } else {
          el.textContent = "+";
          el.onclick = () => openEquipmentModal(slot); // Or however you equip
        }
      });

      ["accessory1", "accessory2"].forEach(slot => {
        const element = document.getElementById(`${slot}-slot`);
        const item = state.equipment[slot];
        if (item && item.image) {
          element.style.backgroundImage = `url(${item.image})`;
          element.title = item.name;
        } else {
          element.style.backgroundImage = '';
          element.title = slot.replace(/([a-z])([A-Z])/g, '$1 $2');
        }
      })
    };

    function getGrowthTable() {
      return {
        Guide: [
          { range: [1, 10], primary: 1, secondary: 0.5, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 2, secondary: 1.5, tertiary: 1 },
          { range: [81, 110], primary: 2.5, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 3, secondary: 2, tertiary: 1.5 },
          { range: [141, 170], primary: 3, secondary: 2.5, tertiary: 2 },
          { range: [171, Infinity], primary: 4, secondary: 3, tertiary: 3 }
        ],
        Fisherman: [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 2, secondary: 2, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 3, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 4, secondary: 3, tertiary: 3 }
        ],
        "Spear Bearer": [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
        ],
        "Wave Controller": [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
        ],
        "Light Bearer": [
          { range: [1, 10], primary: 1, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 1.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3, secondary: 1, tertiary: 1 },
          { range: [81, 110], primary: 3, secondary: 2, tertiary: 1 },
          { range: [111, 140], primary: 4, secondary: 2, tertiary: 2 },
          { range: [141, 170], primary: 4, secondary: 3, tertiary: 2 },
          { range: [171, Infinity], primary: 5, secondary: 3, tertiary: 2 }
        ],
        Anima: [
          { range: [1, 10], primary: 2, secondary: 1, tertiary: 0.5 },
          { range: [11, 25], primary: 2.5, secondary: 1, tertiary: 0.5 },
          { range: [26, 50], primary: 3, secondary: 1, tertiary: 0.5 },
          { range: [51, 80], primary: 3.5, secondary: 1.5, tertiary: 1 },
          { range: [81, 110], primary: 4, secondary: 1.5, tertiary: 1 },
          { range: [111, 140], primary: 5, secondary: 2, tertiary: 1.5 },
          { range: [141, 170], primary: 6, secondary: 2, tertiary: 1.5 },
          { range: [171, Infinity], primary: 6, secondary: 2, tertiary: 2 }
        ]
      };
    }

    function getGrowthRatesForLevel(position, level) {
      const table = getGrowthTable()[position] || [];
      return table.find(r => level >= r.range[0] && level <= r.range[1]) || { primary: 0, secondary: 0, tertiary: 0 };
    }

    function updateFromTextbox() {
      const level = parseInt(document.getElementById("char-level").value);
      const pos = document.getElementById("char-position").value;
      const priList = state.affinities.primary;
      const secList = state.affinities.secondary;
      const terList = state.affinities.tertiary;

      stats.forEach(stat => {
        const base = 1;
        let total = base;

        for (let i = 1; i <= level; i++) {
          const rates = getGrowthRatesForLevel(pos, i);
          if (priList.includes(stat)) total += rates.primary;
          if (secList.includes(stat)) total += rates.secondary;
          if (terList.includes(stat)) total += rates.tertiary;
        }

        state.statValues[stat] = total + state.manualStatPoints[stat];
      });
      const totalAllocatedStatPoints = Object.values(state.manualStatPoints).reduce((sum, val) => sum + val, 0);

      state.availableStatPoints = level - totalAllocatedStatPoints - 1;
      state.availableSkillPoints = level - state.usedSkillPoints - 1 + state.bonusSkillPoints;
      document.getElementById("available-stat-points").value = state.availableStatPoints;
      document.getElementById("available-skill-points").value = state.availableSkillPoints;
      renderStats();
      renderHpSpeed();
      renderAffinityControls();
      renderEquipment();
    }

    function renderDerivedStats() {
      document.getElementById("derived-attack").textContent = state.derivedStats.attack;
      document.getElementById("derived-defense").textContent = state.derivedStats.defense;
    }


    function renderStats() {
      const tbody = document.getElementById("stats-body");
      tbody.innerHTML = "";

      const average = stats.reduce((sum, stat) => sum + state.statValues[stat], 0) / stats.length;
      const max = parseFloat(document.getElementById("stat-multiplier").value) * average;

      stats.forEach(stat => {
        const tr = document.createElement("tr");

        const td1 = document.createElement("td");
        td1.textContent = stat;

        const td2 = document.createElement("td");
        td2.innerHTML = `
          ${state.statValues[stat].toFixed(1)}
          <div class="stat-breakdown">(Base ${(state.statValues[stat] - state.manualStatPoints[stat]).toFixed(1)} + Manual ${state.manualStatPoints[stat]})</div>
        `;

        const td3 = document.createElement("td");
        const addBtn = document.createElement("button");
        const removeBtn = document.createElement("button");
        addBtn.textContent = "+";
        removeBtn.textContent = "â€“";

        addBtn.onclick = () => {
          if (state.availableStatPoints > 0 && state.statValues[stat] + 1 <= Math.floor(max)) {
            state.statValues[stat]++;
            state.manualStatPoints[stat]++;
            state.availableStatPoints--;
            document.getElementById("available-stat-points").value = state.availableStatPoints;
            updateDerivedStats();
            renderStats();
            renderHpSpeed();
          }
        };

        removeBtn.onclick = () => {
          if (state.manualStatPoints[stat] > 0) {
            state.statValues[stat]--;
            state.manualStatPoints[stat]--;
            state.availableStatPoints++;
            document.getElementById("available-stat-points").value = state.availableStatPoints;
            renderStats();
            renderHpSpeed();
          }
        };

        td3.appendChild(addBtn);
        td3.appendChild(removeBtn);

        tr.appendChild(td1);
        
        tr.appendChild(td2);
        tr.appendChild(td3);
        tbody.appendChild(tr);
      });
    }


    function renderHpSpeed() {
      const floor = parseInt(document.getElementById("char-floor").value);
      const level = parseInt(document.getElementById("char-level").value);
      const se = state.statValues["Shinsu Endurance"];
      const str = state.statValues["Strength"];
      const wp = state.statValues["Willpower"];

      const movePenalty = Math.max(0, 2 * floor - se);
      const speed = 6 + level - movePenalty;

      let hpMultiplier = 2 + Math.floor(level / 25);
      const hp = 3 * se + 2 * str + 1.5 * wp + level * hpMultiplier;

      document.getElementById("hp-speed").innerHTML = `<b>HP:</b> ${Math.round(hp)}<br><b>Movement Speed:</b> ${speed}`;
    }

    function addSkillPoint() {
      state.availableSkillPoints++;
      state.bonusSkillPoints++;
      document.getElementById("available-skill-points").value = state.availableSkillPoints;
    }

    function levelUp() {
      document.getElementById("char-level").value++;
      updateFromTextbox();
    }

    function addSkillSlot(tier) {
      if (!state.skillsByTier[tier]) {
        state.skillsByTier[tier] = [];
      }
      state.skillsByTier[tier].push({ name: "", image: "" });
      renderSkills();
    }


    function resetCharacter() {
      if (!auth.currentUser) return;
      db.collection("characters").doc(auth.currentUser.uid).delete().then(() => {
        document.getElementById("char-name").value = "";
        document.getElementById("char-race").value = "";
        document.getElementById("char-level").value = 1;
        document.getElementById("char-floor").value = 1;
        state.affinities = { primary: [], secondary: [], tertiary: [] };
        state.statValues = Object.fromEntries(stats.map(stat => [stat, 1]));
        state.manualStatPoints = Object.fromEntries(stats.map(stat => [stat, 0]));
        state.skillSlots = [];
        updateFromTextbox();
        renderSkills();
      });
    }

    function applySkillEffects() {
      // Clear all skill-modified stats first
      state.derivedStats = {};

      for (let tier = 1; tier <= 5; tier++) {
        for (const skill of state.skillsByTier[tier]) {
          if (!skill || skill.level === 0) continue;

          const effect = skill.effects?.[skill.level - 1];
          if (!effect) continue;

          const { stat, type, value } = effect;

          if (!state.derivedStats[stat]) state.derivedStats[stat] = 0;

          switch (type) {
            case "add":
              state.derivedStats[stat] += value;
              break;
            case "mul":
              state.derivedStats[stat] *= value;
              break;
            case "limit":
              state.derivedStats[stat] = Math.min(state.derivedStats[stat], value);
              break;
          }
        }
      }
    }

    function updateDerivedStats() {
      const stats = state.statValues;
      const eq = state.equipment;

      // Use selected weapon if valid
      const selected = state.selectedWeaponSlot;
      let attack = 0;
      if (selected && eq[selected]) {
        const weapon = eq[selected];
        const base = stats[weapon.stat] || 0;
        attack = Math.floor(base / 5) + (weapon.modifier || 0);
      }

      // Armor for defense
      let defense = 0;
      if (eq.armor) {
        const armor = eq.armor;
        const base = stats[armor.stat] || 0;
        defense = Math.floor(base / 5) + (armor.modifier || 0);
      }

      state.derivedStats = { attack, defense };

      document.getElementById("derived-attack").textContent = `Attack: ${attack}`;
      document.getElementById("derived-defense").textContent = `Defense: ${defense}`;
    }



    function equipItem(slot, item) {
      state.equipment[slot] = item;
      updateDerivedStats();
      renderEquipment(); // optional UI update
    }



    function calculateUsedSkillPoints() {
      let total = 0;
      for (let tier = 1; tier <= 5; tier++) {
        for (const skill of state.skillsByTier[tier]) {
          if (skill && skill.costPerLevel && skill.level > 0) {
            for (let i = 0; i < skill.level; i++) {
              total += skill.costPerLevel[i] || 1;
            }
          }
        }
      }
      state.usedSkillPoints = total;
      state.availableSkillPoints = (state.level - 1) - total;
    }


    function levelUpSkill() {
      const { tier, index } = state.currentSkillEdit;
      const skill = state.skillsByTier[tier][index];
      if (!skill || skill.level >= skill.maxLevel) return;

      const cost = skill.costPerLevel[skill.level] || 1;
      if (state.availableSkillPoints < cost) return;

      skill.level++;
      calculateUsedSkillPoints();
      renderSkillModal();
      renderSkillTiers();
      renderDerivedStats();
    }

    function refundSkill() {
      const { tier, index } = state.currentSkillEdit;
      const skill = state.skillsByTier[tier][index];
      if (!skill || skill.level <= 0) return;

      skill.level--;
      calculateUsedSkillPoints();
      renderSkillModal();
      renderSkillTiers();
      renderDerivedStats();
    }





    function renderSkills() {
      const section = document.getElementById("skill-section");
      section.innerHTML = "";

      for (let tier = 1; tier <= 5; tier++) {
        const tierDiv = document.createElement("div");
        tierDiv.className = "tier-section";

        const header = document.createElement("div");
        header.className = "tier-header";
        header.innerHTML = `<strong>Tier ${tier}</strong> <button onclick="addSkillSlot(${tier})">Add Skill Slot</button>`;
        tierDiv.appendChild(header);

        const slotContainer = document.createElement("div");
        slotContainer.className = "skill-slots";
        slotContainer.id = `tier-${tier}-slots`;

        state.skillsByTier[tier].forEach((skill, idx) => {
          const slot = document.createElement("div");
          slot.className = "skill-slot";
          slot.onclick = () => openSkillLibrary(tier, idx);
          if (skill && skill.image) {
            const img = document.createElement("img");
            img.src = skill.image;
            slot.appendChild(img);
          } else {
            slot.textContent = "+";
          }
          slotContainer.appendChild(slot);
        });

        tierDiv.appendChild(slotContainer);
        section.appendChild(tierDiv);
      }
    }


    function renderSkillTiers() {
      const container = document.getElementById("skill-section");
      container.innerHTML = "";

      for (let tier = 1; tier <= 5; tier++) {
        const tierDiv = document.createElement("div");
        tierDiv.className = "tier-section";

        // Header
        const headerDiv = document.createElement("div");
        headerDiv.className = "tier-header";

        const headerTitle = document.createElement("h4");
        headerTitle.textContent = `Tier ${tier}`;
        headerDiv.appendChild(headerTitle);

        const addBtn = document.createElement("button");
        addBtn.textContent = "Add Skill Slot";
        addBtn.onclick = () => addSkillSlot(tier);
        headerDiv.appendChild(addBtn);

        tierDiv.appendChild(headerDiv);

        // Slots
        const slotGrid = document.createElement("div");
        slotGrid.className = "skill-slots";

        const skills = state.skillsByTier[tier] || [];
        skills.forEach((skill, index) => {
          const slot = document.createElement("div");
          slot.className = "skill-slot";
          if (!skill || !skill.image) {
            slot.classList.add("empty");
          } else {
            const img = document.createElement("img");
            img.src = skill.image;
            img.alt = skill.name;
            slot.appendChild(img);
          }

          slot.onclick = () => openSkillLibrary(tier, index);
          slotGrid.appendChild(slot);
        });

        tierDiv.appendChild(slotGrid);
        container.appendChild(tierDiv);
      }
    }

    function openSkillLibrary(tier, index) {
      state.currentSkillEdit = { tier, index };
      document.getElementById("skill-library-modal").classList.add("active");
      renderSkillLibrary();
    }

    function closeSkillLibrary() {
      document.getElementById("skill-library-modal").classList.remove("active");
    }

    function renderSkillLibrary() {
      const grid = document.getElementById("skill-library-grid");
      grid.innerHTML = "";

      const filtered = state.skillLibrary.filter(skill => {
        const position = document.getElementById("char-position").value;
        return skill.positionTags.includes(position);
      });

      filtered.forEach(skill => {
        const card = document.createElement("div");
        card.className = "skill-card";
        card.onclick = () => selectSkill(skill);

        card.innerHTML = `
      <img src="${skill.icon}" alt="${skill.name}" />
      <div class="skill-name">${skill.name}</div>
      <div class="skill-description">${skill.description}</div>
    `;

        grid.appendChild(card);
      });
    }

    function selectSkill(skill) {
      const { tier, index } = state.currentSkillEdit;
      if (tier && index !== null && state.skillsByTier[tier]) {
        state.skillsByTier[tier][index] = {
          name: skill.name,
          image: skill.icon
        };
        renderSkills();
        closeSkillLibrary();
      }
    }



    document.addEventListener("DOMContentLoaded", () => {
      renderSkillTiers();
    });


    state.skillLibrary = [
      {
        name: "Fireball",
        icon: "https://dummyimage.com/100x100/ff4444/ffffff&text=F",
        description: "Launches a fiery orb that explodes on impact.",
        positionTags: ["Wave Controller", "Anima"],
        level: 0,
        maxLevel: 10,
        costPerLevel: [5, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
        effects: [
          { stat: "strength", type: "add", value: 5 },
          { stat: "strength", type: "add", value: 10 },
          { stat: "strength", type: "add", value: 15 }
        ],
        maxTier: 4
      },
    ];

    state.equipment.weapon1 = {
      name: "Iron Sword",
      type: "weapon",
      stat: "strength",
      modifier: 5
    };

    state.equipment.armor = {
      name: "Leather Armor",
      type: "armor",
      stat: "willpower",
      modifier: 3
    };

    updateDerivedStats(); // Don't forget to recalculate!



    // Initialize
    window.onload = () => {
      renderAffinityControls();
      updateFromTextbox();
      renderSkills();
      renderEquipment();
      renderSkillTiers();

    };

  </script>


</body>

</html>